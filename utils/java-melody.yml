- name: Download java melody and it's dependencies
  local_action: get_url
  args:
    url: "{{ item.url }}"
    dest:  "/tmp/{{ item.dest }}"
  with_items:
    - { url: 'https://github.com/javamelody/javamelody/releases/download/javamelody-core-1.73.1/javamelody-core-1.73.1.jar', dest: 'javamelody.jar' }
    - { url: 'https://repo1.maven.org/maven2/org/jrobin/jrobin/1.5.9/jrobin-1.5.9.jar', dest: 'jrobin-1.5.9.jar' }

- name: Copy jars in tds instances
  copy:
    src: /tmp/{{ item.0 }}
    dest: "{{ tomcat_base }}/{{ item.1.name }}/webapps/thredds/WEB-INF/lib/"
  with_nested:
    - [ 'javamelody.jar', 'jrobin-1.5.9.jar']
    - "{{ tds_instances }}"

- name: Add /monitoring to gateway urimaps
  delegate_to: "{{ item.1.proxy }}"
  run_once: True
  lineinfile:
    path: "{{ hostvars[item.1.proxy].mod_jk_conf_path }}/mod_jk.urimaps"
    line: /thredds/monitoring=COLLECTION_udg-tds
  when: item.1.protocol.lower().startswith("ajp")
  with_subelements: 
    - "{{ tds_instances }}"
    - connectors
