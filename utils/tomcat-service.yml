- name: Stop tomcats
  command: "{{ tomcat_base }}/{{ item }}/bin/shutdown.sh"
  args:
    removes: "{{ tomcat_base }}/{{ item }}/logs/catalina.pid"
  tags: [never, stop, restart]
  with_items: "{{ tomcats }}"
  ignore_errors: True # If catalina.pid is present but process is not running, we don't want an error
  # If there is any case where this should fail, use failed_when

- name: Remove tomcats catalina.pid
  file: path={{ tomcat_base }}/{{ item }}/logs/catalina.pid state=absent
  tags: [never, stop, restart]
  with_items: "{{ tomcats }}"

- name: Start tomcats
  shell: "nohup {{ tomcat_base }}/{{ item }}/bin/startup.sh"
  args:
    creates: "{{ tomcat_base }}/{{ item }}/logs/catalina.pid"
  register: started
  tags: [never, start, restart]
  with_items: "{{ tomcats | default(['tomcat']) }}"

- name: Wait for content/thredds initialization
  wait_for: path={{ tomcat_base }}/{{ item }}/content/thredds/catalog.xml delay=3
  when: started is changed
  tags: [never, start, restart]
  with_items: "{{ tomcats | default(['tomcat']) }}"