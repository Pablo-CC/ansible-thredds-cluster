- hosts: localhost
  vars:
    root: /tmp/sandbox
    # roles customization
    tomcat_base: "{{ root }}"

    tds_version: 5.0.0-beta2

    miniconda_python: 2
    miniconda_prefix: "{{ root }}/miniconda"
    miniconda_manage_dependencies: False
    miniconda_env:
      name: tds
      channels:
        - birdhouse
      dependencies:
        - libnetcdf=4.4.1
        - supervisor
        - apache-tomcat

    ## tds instances
    tds_instances:
      - name: tomcat
        shutdown: 8089
        connectors:
          - type: http
            port: 8080

  roles:
    - role: miniconda
    - role: tds
    - role: supervisor-tds

  tasks:
    # management
    - name: Restart TDS
      supervisorctl:
        name: "{{ item.name }}"
        state: restarted
        supervisorctl_path: "{{ supervisor_home }}/bin/supervisorctl"
      with_items:
        - "{{ tds_instances }}"
      tags: ['restart']

    - name: Stop TDS
      supervisorctl:
        name: "{{ item.name }}"
        state: stopped
        supervisorctl_path: "{{ supervisor_home }}/bin/supervisorctl"
      with_items:
        - "{{ tds_instances }}"
      tags: ['stop', 'never']

    - name: Stop supervisor 
      shell: kill $(cat {{ supervisor_home }}/var/supervisord.pid)
      tags: ['stop', 'never']
