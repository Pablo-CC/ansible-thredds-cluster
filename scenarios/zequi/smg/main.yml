- name: Deployment of the tds gateway
  hosts: proxies
  vars_files:
    - proxies_vars.yml
    - deployment.yml
    - secret.yml
  roles:
    - role: supervisord-virtualenv
    - role: httpd
    - role: tds-gateway

- name: Deployment of the tds instances
  hosts: backend
  vars_files:
    - backend_vars.yml
    - deployment.yml
    - secret.yml
  roles:
    - role: supervisord-conda
    - role: tds
#    - role: tap

  tasks:
    - include_tasks: derby-authentication.yml

    - name: restart tomcat_instance
      supervisorctl:
        name: "{{ item.name }}"
        state: restarted
        supervisorctl_path: "{{ venv_home }}/bin/supervisorctl"
        config: "{{ supervisord_etc }}/supervisord.conf"
        username: "{{ applications.supervisord.user }}"
        password: "{{ applications.supervisord.password }}"
        server_url: "http://localhost:{{ supervisord_port }}"
      with_items:
        - "{{ tds_instances }}"
      tags: update_catalogs
    
    - name: restart httpd
      supervisorctl:
        name: httpd
        state: restarted
        username: "{{ applications.supervisord.user }}"
        password: "{{ applications.supervisord.password }}"
        server_url: "http://{{ hostvars[item].ansible_nodename }}:{{ supervisord_port }}"
        supervisorctl_path: "{{ hostvars[item].tdscc.venv_home }}/bin/supervisorctl"
      run_once: True
      delegate_to: "{{ item }}"
      with_items: "{{ groups.proxies }}"
