# Provisioning of the machines
- name: Provision hosts
  hosts: all
  become: True
  tasks:
    - yum:
        name: epel-release

    - yum:
        name: "{{ item }}"
        state: present
      with_items:
        - "@Development tools"
        - python-passlib
        - net-tools # apt?
        - unzip
        - vim

# TDS Collections deployment
- hosts: proxies
  vars:
    httpd_server_root: "{{ ansible_env.HOME }}/httpd"
    httpd_port: 8080
    mod_jk_configure: --prefix={{ httpd_server_root }}/modules --with-apxs={{ httpd_server_root }}/bin/apxs
    venv_home: "{{ httpd_server_root }}/virtualenv"
  vars_files:
    - secret.yml
  roles:
    - role: supervisord-virtualenv
    - role: httpd
    - role: jk-gateway

- hosts: backend
  vars:
    miniconda_python: 2
    miniconda_prefix: "{{ ansible_env.HOME }}/miniconda2"
    miniconda_env:
      name: udg
      dependencies:
        - libnetcdf=4.4.1
        - supervisor=3.1.3

    derby_db_download_url: http://archive.apache.org/dist/db/derby/db-derby-10.12.1.1/db-derby-10.12.1.1-lib.tar.gz
    derby_db_filename: db-derby-10.12.1.1-lib.tar.gz

    venv_home: "{{ miniconda_prefix }}/envs/{{ miniconda_env.name }}"

    tds_debug: True
  vars_files:
    - secret.yml
  roles:
    - role: supervisord-conda
    - role: tds

  tasks:
    # - include_tasks: derby-authentication.yml
    - include_tasks: test-authentication.yml

    - name: restart httpd
      supervisorctl:
        name: httpd
        state: restarted
        username: "{{ applications.supervisord.user }}"
        password: "{{ applications.supervisord.password }}"
        supervisorctl_path: "{{ hostvars[item].venv_home }}/bin/supervisorctl"
      run_once: True
      delegate_to: "{{ item }}"
      with_items: "{{ groups.proxies }}"
      tags: restart

    - name: restart tds instances
      supervisorctl:
        name: "{{ item.name }}"
        state: restarted
        username: "{{ applications.supervisord.user }}"
        password: "{{ applications.supervisord.password }}"
        supervisorctl_path: "{{ venv_home }}/bin/supervisorctl"
      with_items: "{{ tds_instances }}"
      tags: ["restart","update_catalogs"]

# - hosts: hostA
#   roles:
#     - role: logstash
#       logstash_home: "{{ ansible_env.HOME }}/tomcat"
#       logstash_pipeline: "pipeline.conf"
