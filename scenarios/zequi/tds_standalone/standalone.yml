- hosts: all
  vars:
    # roles customization
    tomcat_catalina_home: "/home/{{ ansible_env.USER }}/tds_test"
    miniconda_python: 2
    miniconda_prefix: "{{ tomcat_catalina_home }}/miniconda2"
    miniconda_env:
      name: udg
      dependencies:
        - libnetcdf=4.4.1
        - supervisor=3.1.3
    venv_home: "{{ miniconda_prefix }}/envs/{{ miniconda_env.name }}"
    
    # secrets
    applications:
      supervisord:
        user: supervisor    
        password: supervisor

    # collections
    collections:
      - path: test-collection
        catalogs:
          src: "{{ catalogs_path | default('data/catalogs') }}"

    # tds instances
    tds_instances:
      - name: instance1
        shutdown: 8089
        connectors:
          - type: http
            port: '8080'
        replicas:
          - name: test-collection

    datasets:
      - src: "{{ datasets_path | default('data/datasets') }}"
        dest: '' # If empty, destination is content/thredds/public
    
  roles:
    - role: supervisord-conda
    - role: tds

  tasks:
    - name: Restart TDS
      supervisorctl:
        name: "{{ item.name }}"
        state: restarted
        supervisorctl_path: "{{ venv_home }}/bin/supervisorctl"
        username: "{{ applications.supervisord.user }}"
        password: "{{ applications.supervisord.password }}"
      with_items:
        - "{{ tds_instances }}"
      tags:
        - restart
        - update_catalogs
