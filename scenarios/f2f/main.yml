- name: Generate DRS and local publication
  hosts: gateway
  tasks:
    - name: Copy esgf-httpd.conf with cog options removed
      copy: src=esgf-httpd.conf dest=/etc/httpd/conf/esgf-httpd.conf

    - name: Copy sftlf.nc to /esg/data/test
      copy: src=sftlf.nc dest=/esg/data/test/sftlf.nc
      tags: drs

    - name: Copy esgf_policies_local.xml
      copy: src=esgf_policies_local.xml dest=/esg/config/esgf_policies_local.xml

    - name: mkdir /esg/data/drs
      file:
        state: directory
        path: /esg/data/drs
      tags: drs

    - name: Copy esg.test.ini
      copy: src=esg.test.ini dest=/esg/config/esgcet/esg.test.ini
      tags: drs

    - name: esgdrs
      command: esgdrs {{ item }} --project test --symlink  --set-value project=Test /esg/data/test/
      args:
        chdir: /esg/data/drs
      with_items: [list, tree, todo, upgrade]
      tags: [never,drs]

    - name: esgmapfile
      command: esgmapfile --project test Test/
      args:
        chdir: /esg/data/drs
      tags: [never,publish]

    - name: esgpublish
      shell: "yes no | esgpublish --project test --map mapfiles/ --service fileservice --thredds"
      args:
        chdir: /esg/data/drs
      ignore_errors: True
      tags: [never,publish]

    - name: Link esg_dataroot to esgcet
      file:
        state: link
        src: /esg/content/thredds/esgcet
        dest: /esg/content/thredds/esg_dataroot

- name: Set up the gateway
  hosts: gateway
  vars:
    # httpd is already installed, fill the interface
    httpd_root: /etc/httpd
    httpd_version: 2.2.15
    httpd_htdocs: /var/www/html
    httpd_conf_file: /etc/httpd/conf/esgf-httpd.conf
  roles:
    - role: gateway-proxy
    - role: tds-modproxy
  tasks:
    - name: Copy hostcert.pem and hostkey.pem
      copy: src={{ item }} dest=/etc/certs/{{ item }}
      with_items: [hostcert.pem, hostkey.pem]

    - name: Copy keystore and truststore
      copy: src={{ item }} dest=/esg/config/tomcat/{{ item }}
      with_items: [keystore-tomcat, esg-truststore.ts, cacert.pem]

    - name: Comment ProxyPass /thredds in esgf-httpd.conf
      replace:
        path: "{{ httpd_conf_file }}"
        regexp: "(ProxyPass /thredds\tajp://localhost:8223/thredds)"
        replace: '#\1'

    - name: Add DocumentRoot {{ httpd_htdocs }} to {{ httpd_conf_file }}
      lineinfile:
        path: "{{ httpd_conf_file }}"
        insertafter: NameVirtualHost \\*:80
        line: DocumentRoot /var/www/html

    - name: Rewrite /thredds to /thredds/catalog/catalog.html
      blockinfile:
        path: "{{ httpd_conf_file }}"
        insertafter: Header always set X-Content-Type-Options nosniff
        block: |
          RewriteEngine on
          RewriteRule   "^/thredds/?$" "/thredds/catalog/catalog.html" [R]

    - name: Replace localhost by gateway IP in esgf.properties
      replace:
        path: /esg/config/esgf.properties
        regexp: https://localhost/esg-orp
        replace: https://{{ ansible_eth1.ipv4.address }}/esg-orp

    - name: Replace localhost by gateway IP in thredds web.xml
      replace:
        path: "/usr/local/tomcat/webapps/thredds/WEB-INF/web.xml"
        regexp: localhost/esg-orp
        replace: "{{ hostvars['esgf'].ansible_eth1.ipv4.address }}/esg-orp"

    - name: Restart ESGF node
      command: 'esg-node restart'
      tags: [never, restart]

- name: Set up backend servers
  hosts: backend
  vars:
    # Download TDS in the gateway fails because of selinux and local_action
    ansible_python_interpreter: /usr/bin/python
    
    # Miniconda variables
    miniconda_python: 2
    miniconda_env:
      name: f2f
      channels:
        - birdhouse
      dependencies:
        - libnetcdf=4.4.1
        - supervisor
        - apache-tomcat
    
    # TDS variables
    tds_download_url: "http://artifacts.unidata.ucar.edu/content/repositories/unidata-releases/edu/ucar/tds/ESGF-5.0.1/tds-ESGF-5.0.1.war"
    tds_version: "ESGF-5.0.1"
    tds_filename: "tds-esgf.war"
  roles:
    - role: miniconda
    - role: supervisor-tds
    - role: tds-modproxy
  tasks:
    - name: Synchronize thredds and esg-orp
      synchronize:
        src: "/usr/local/tomcat/webapps/{{ item.1 }}"
        dest: "{{ tomcat_base }}/{{ item.0.name }}/webapps/"
      with_nested:
        - "{{ tds}}"
        - ["thredds"] # Parece que el orp no hace falta, esg-security en el thredds

    - name: Copy truststore and keystore
      copy:
        src: /esg/config/tomcat/{{ item.1 }}
        dest: "{{ tomcat_base }}/{{ item.0.name }}/conf"
      with_nested:
        - "{{ tds }}"
        - ["esg-truststore.ts", "keystore-tomcat"]

    - name: Replace /esg/config/tomcat locations
      shell: "grep -r '/esg/config/tomcat' | cut -d ':' -f 1 | grep -v bak | xargs sed -i 's|/esg/config/tomcat|{{ tomcat_base }}/{{ item.name }}/conf|g'"
      with_items: "{{ tds }}"

    - name: Replace /esg/config locations
      shell: "grep -r '/esg/config' | cut -d ':' -f 1 | grep -v bak | xargs sed -i 's|/esg/config|{{ tomcat_base }}/{{ item.name }}/conf|g'"
      with_items: "{{ tds }}"

    - name: Remove AccessLoggingFilter
      replace:
        path: "{{ tomcat_base }}/{{ item.name }}/webapps/thredds/WEB-INF/web.xml"
        regexp: <filter>\n\s+<filter-name>AccessLoggingFilter(.|\n)*</filter-mapping>
        replace: "<!-- Removed AccessLoggingFilter -->"
      with_items: "{{ tds }}"

    - name: Create datasets directory
      become: True
      file:
        state: directory
        path: /esg/data
        owner: vagrant
        group: vagrant

    - name: Syncronize datasets
      synchronize:
        src: /esg/data/
        dest: /esg/data
        archive: True

    - name: Install openjdk (required for keytool)
      become: True
      yum:
        state: present
        name: java-1.8.0-openjdk

    - name: Copy hostcert.pem
      copy:
        src: /etc/certs/hostcert.pem
        dest: /home/vagrant/miniconda/envs/f2f/opt/hostcert.pem

    - name: Install pyexpect
      pip:
        name: pexpect
        executable: "{{ miniconda_prefix }}/envs/{{ miniconda_env.name }}/bin/pip"

    - name: Add hostcert.pem to miniconda cacerts
      expect:
        command: keytool -import -trustcacerts -alias smg -keystore /home/vagrant/miniconda/envs/f2f/jre/lib/security/cacerts -file /home/vagrant/miniconda/envs/f2f/opt/hostcert.pem
        responses:
          password: "changeit"
          Trust: "yes"
      environment:
        PYTHONPATH: "{{ miniconda_prefix }}/envs/{{ miniconda_env.name }}/lib/python2.7/site-packages/"

    - name: restart TDS instances
      supervisorctl:
        name: "{{ item.name }}"
        state: restarted
        supervisorctl_path: "{{ supervisor_bin }}/supervisorctl"
      with_items: "{{ tds }}"
      ignore_errors: True
      tags: [never, restart]
