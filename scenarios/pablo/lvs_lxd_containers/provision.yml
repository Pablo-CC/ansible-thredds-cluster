- name: Create LXD containers
  hosts: localhost
  connection: local
  tasks:
    - name: Create containers
      lxd_container:
        name: "{{ item }}"
        state: started
        profiles: myprofile
        source:
          type: image
          alias: centos/7
      with_items: "{{ groups['all'] }}"

- name: Fix ipv4 assignment issue
  hosts: all
  connection: lxd
  tasks:
    - name: Edit ifcfg-eth0 file
      lineinfile:
        path: /etc/sysconfig/network-scripts/ifcfg-eth0
        line: "DEVICE=eth1"
        regexp: "DEVICE=eth0"
        state: present
      ignore_errors: True

    - name: Change ifcfg file's name
      command: "mv /etc/sysconfig/network-scripts/ifcfg-eth0 /etc/sysconfig/network-scripts/ifcfg-eth1"
      ignore_errors: True

    - name: ifup eth1
      command: "ifup eth1"
      ignore_errors: True

- name: Set load balancer's container as privileged
  hosts: localhost
  connection: local
  tasks:
    - command: "lxc config set load-balancer security.privileged true"
    - command: "lxc restart load-balancer"


- name: Provision
  hosts: all
  connection: lxd
  tasks:
    - name: Install EPEL repository
      command: "yum install https://dl.fedoraproject.org/pub/epel/epel-release-latest-7.noarch.rpm -y"
      ignore_errors: True

    - name: Install software
      yum:
        name:
          - tcpdump
          - sudo
          - iperf3
          - nuttcp
        enablerepo: epel
        state: present


- name: Provision servers
  hosts: servers
  connection: lxd
  tasks:
    - name: Install software
      yum:
        name:
          - net-tools
          - unzip
          - iptables
        state: present

- name: Provision Load Balancer
  hosts: load-balancer
  connection: lxd
  tasks:
    - name: Install software
      yum:
        name:
          - ipvsadm
        state: present
