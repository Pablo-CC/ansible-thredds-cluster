- name: Gather facts on all hosts
  hosts: all
  become: True
  gather_facts: True

- name: Configure router
  hosts: router
  become: True
  tasks:
    - name: Enable IP forwarding
      sysctl:
        name: net.ipv4.ip_forward
        value: 1
        
- name: Configure load-balancer
  hosts: load-balancer
  become: True
  roles:
    - ipvsadm
         
             
- name: Configure servers with Tomcat
  hosts: servers
  become: True
  vars_files:
    - secret.yml

  vars:
    miniconda_python: 2
    miniconda_prefix: "{{ ansible_env.HOME }}/miniconda2"
    miniconda_env:
      name: udg
      dependencies:
        - libnetcdf=4.4.1
        - supervisor
    venv_home: "{{ miniconda_prefix }}/envs/{{ miniconda_env.name }}"
  roles:
    - role: ansible-miniconda-role
    - role: supervisord-conda
    - role: tds
  
- name: Configure servers with iptables
  hosts: servers
  become: True
  roles:
    - iptables

- name: Configure static routes on load balancer and servers
  hosts:
    - servers
    - load-balancer
  become: True
  tasks:
    - name: Delete default route
      command: "ip route del default"

    - name: Add default route through router
      command: "ip route add default via {{ hostvars['router']['ansible_eth2']['ipv4']['address'] }}"

- name: Configure static routes on client
  hosts: client
  become: True
  tasks:
    - name: Delete default route
      command: "ip route del default"
    - name: Add default route through router
      command: "ip route add default via {{ hostvars['router']['ansible_eth1']['ipv4']['address'] }}"





