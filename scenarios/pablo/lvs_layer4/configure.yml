- name: Gather facts on all hosts
  hosts: all
  become: True
  gather_facts: True

##### Router configuration #####
- name: Configure router
  hosts: router
  become: True
  tasks:
    - name: Enable IP forwarding
      sysctl:
        name: net.ipv4.ip_forward
        value: 1
     

##### Load balancer configuration #####
- name: Configure load-balancer
  hosts: load-balancer
  become: True
  roles:
    - ipvsadm
  tasks:
    - name: Delete default route
      command: "ip route del default"
    - name: Add default route through router
      command: "ip route add default via {{ hostvars['router']['ansible_eth2']['ipv4']['address'] }}"
   
         
##### Servers configuration #####               
- name: Configure servers
  hosts: servers
  become: True
  vars_files:
    - secret.yml

  vars:
    miniconda_python: 2
    miniconda_prefix: "{{ ansible_env.HOME }}/miniconda2"
    miniconda_env:
      name: udg
      dependencies:
        - libnetcdf=4.4.1
        - supervisor
    venv_home: "{{ miniconda_prefix }}/envs/{{ miniconda_env.name }}"
  roles:
    - name: Deploy and configure miniconda
      role: ansible-miniconda-role
    - name: Deploy python virtualenv on top of miniconda
      role: supervisord-conda
    - name: Deploy a TDS instance inside Tomcat
      role: tds
    - name: Configure Iptables rule to accept packets destined to VIP
      role: iptables

  tasks:
    - name: Delete default route
      command: "ip route del default"
    - name: Add default route through router
      command: "ip route add default via {{ hostvars['router']['ansible_eth2']['ipv4']['address'] }}"



##### Client configuration #####
- name: Configure client
  hosts: client
  become: True
  tasks:
    - name: Delete default route
      command: "ip route del default"
    - name: Add default route through router
      command: "ip route add default via {{ hostvars['router']['ansible_eth1']['ipv4']['address'] }}"
