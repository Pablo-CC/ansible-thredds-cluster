- name: Configure DHCP server
  hosts: dhcp
  become: True
  tasks:
    - name: Create eth1 configuration file
      copy:
        src: ifcfg-eth1-dhcp_server
        dest: /etc/sysconfig/network-scripts/ifcfg-eth1
          
    - name: ifup eth1
      command: "ifup eth1"

    - name: Create DHCP configuration file
      copy:
        src: dhcpd.conf
        dest: /etc/dhcp/dhcpd.conf

    - name: Enable DHCP
      systemd:
        name: dhcpd.service
        enabled: True

- name: Configure router
  gather_facts: True
  hosts: router
  become: True
  tasks:
    - name: Create eth2 configuration file
      copy:
        src: ifcfg-eth2
        dest: /etc/sysconfig/network-scripts/ifcfg-eth2
        
    - name: Register in DHCP server
      blockinfile:
        path: /etc/dhcp/dhcpd.conf
        block: |
          host router{
            hardware ethernet {{ ansible_eth2.macaddress }};
            fixed-address 192.0.2.1;
          }
      delegate_to: dhcp

    - name: ifup eth2
      command: "ifup eth2"

    - name: Enable ip forwarding
      sysctl:
        name: net.ipv4.ip_forward
        value: 1

- name: Configure L.B. and Servers
  hosts:
    - load-balancer
    - servers
  become: True
  tasks:
    - name: Create eth1 configuration file
      copy:
        src: ifcfg-eth1
        dest: /etc/sysconfig/network-scripts/ifcfg-eth1
        
    - name: ifup eth1
      command: "ifup eth1"
