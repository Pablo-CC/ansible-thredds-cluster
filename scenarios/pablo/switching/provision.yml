- name: Provision DHCP server
  hosts: dhcp
  become: True
  tasks:
    - name: Install DHCP 
      yum:
        name: dhcp
        state: present

    - name: Create eth1 configuration file
      copy:
        src: ifcfg-eth1-dhcp_server
        dest: /etc/sysconfig/network-scripts/ifcfg-eth1
          
    - name: ifup eth1
      command: "ifup eth1"

    - name: Create DHCP configuration file
      copy:
        src: dhcpd.conf
        dest: /etc/dhcp/dhcpd.conf

    - name: Start DHCP
      systemd:
        name: dhcpd
        state: restarted

- name: Provision for router
  gather_facts: True
  hosts: router
  become: True
  tasks:
    - name: Create eth1 configuration file
      copy:
        src: ifcfg-eth1
        dest: /etc/sysconfig/network-scripts/ifcfg-eth1
        
    - name: Register in DHCP server
      blockinfile:
        path: /etc/dhcp/dhcpd.conf
        block: |
          host router{
            hardware ethernet {{ ansible_eth1.macaddress }};
            fixed-address 192.0.2.1;
          }
      delegate_to: dhcp

    - name: ifup eth1
      command: "ifup eth1"

    - name: Enable ip forwarding
      sysctl:
        name: net.ipv4.ip_forward
        value: 1

- name: Common provision for load balancer and servers
  hosts:
    - servers
    - load-balancer
  become: True
  tasks:
    - name: Install neccessary software
      yum:
        name: "{{ item }}"
        state: present
      with_items:
        - tcpdump


- name: Provision for load-balancer
  hosts: load-balancer
  become: True
  tasks:
    - name: Install software
      yum:
        name: "{{ item }}"
        state: present
      with_items:
        - ipvsadm

- name: Provision for servers
  hosts: servers
  become: True
  tasks:
    - name: Install software
      yum:
        name: "{{ item }}"
        state: present
      with_items:
        - net-tools
        - unzip
        - iptables

- name: Interface configuration of L.B. and Servers
  hosts:
    - load-balancer
    - servers
  become: True
  tasks:
    - name: Create eth1 configuration file
      copy:
        src: ifcfg-eth1
        dest: /etc/sysconfig/network-scripts/ifcfg-eth1
        
    - name: ifup eth1
      command: "ifup eth1"
