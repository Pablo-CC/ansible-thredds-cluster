- name: Gather facts on all hosts
  hosts: all
  become: true
  gather_facts: True

##### DHCP server's networking configuration #####    
- name: Configure DHCP server
  hosts: dhcp
  become: True
  tasks:
    - name: Create eth1 configuration file
      template:
        src: ifcfg-eth1-dhcp_server
        dest: /etc/sysconfig/network-scripts/ifcfg-eth1
          
    - name: ifup eth1
      command: "ifup eth1"

    - name: Create DHCP configuration file
      template:
        src: dhcpd.conf
        dest: /etc/dhcp/dhcpd.conf

    - name: Enable DHCP
      systemd:
        name: dhcpd.service
        enabled: True

    - name: Start DHCP
      systemd:
        name: dhcpd.service
        state: started

##### Router's networking configuration #####
- name: Configure router
  gather_facts: True
  hosts: router
  become: True
  tasks:
    - name: Create eth2 configuration file
      copy:
        src: ifcfg-eth2
        dest: /etc/sysconfig/network-scripts/ifcfg-eth2
        
    - name: Register in DHCP server
      blockinfile:
        path: /etc/dhcp/dhcpd.conf
        block: |
          host router{
            hardware ethernet {{ ansible_eth2.macaddress }};
            fixed-address {{ gateway_ip }};
          }
      delegate_to: dhcp

    - name: ifup eth2
      command: "ifup eth2"


##### Client's networking configuration #####
- name: Configure client
  hosts: client
  become: True
  tasks:
    - name: Delete default route
      command: "ip route del default"
      tags: [restart]
    - name: Add default route through router
      command: "ip route add default via {{ gateway_ip }}"
      tags: [restart]
    - name: Enable ip forwarding
      sysctl:
        name: net.ipv4.ip_forward
        value: 1

##### Common networking configuration for Load Balancer and Servers #####
- name: Configure L.B. and Servers
  hosts:
    - load-balancer
    - servers
  become: True
  tasks:
    - name: Create eth1 configuration file
      copy:
        src: ifcfg-eth1
        dest: /etc/sysconfig/network-scripts/ifcfg-eth1
        
    - name: ifup eth1
      command: "ifup eth1"

##### Servers' networking configuration #####
- name: Delete default route
  command: "ip route del default"
  tags: [restart]

- name: Add default route through router
  command: "ip route add default via {{ gateway_ip }}"
  tags: [restart]


