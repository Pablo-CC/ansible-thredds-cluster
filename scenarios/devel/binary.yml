- hosts: gateway
  become: True
  vars:
    mod_proxy_status_user: proxy
    mod_proxy_status_passwd: proxy
  roles:
    - role: system-httpd
    - role: httpd
    - role: gateway-proxy
  tasks:
    - name: Change httpd port to 8080
      become: True
      replace:
        path: "{{ httpd_conf_file }}"
        regexp: Listen 80$
        replace: Listen 8080

    - name: Enable httpd network connect in Selinux
      command: /usr/sbin/setsebool -P httpd_can_network_connect 1
        
    - name: restart httpd
      become: True
      systemd:
        state: restarted
        name: httpd
      tags: [never, restart]

- hosts: tds
  become: True
  roles:
    - role: system-tomcat
    - role: system-memcached
    - role: tds
    - role: tds-proxy
    - role: tds-memcached
    - role: systemd-tds
  tasks:
    - include_tasks: ../../utils/test-authentication.yml
      vars:
        instances: "{{ tds_instances }}"

    - name: Change group ownership of tds instances
      shell: chown -R :tomcat {{ tomcat_base }}/*

    - name: Add write permission to tomcat user in tds instances
      shell: chmod -R g+w {{ tomcat_base }}/*
      
    - name: restart memcached
      systemd:
        state: restarted
        name: "memcached.service"
      tags: [never, restart]
        
    - name: restart tds instances
      systemd:
        state: restarted
        name: "tomcat@{{ item.name }}.service"
      with_items: "{{ tds_instances }}"
      tags: [never, restart]
