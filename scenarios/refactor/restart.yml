- name: Stop workers
  command: "{{ tomcat_base }}/{{ item.name }}/bin/shutdown.sh"
  ignore_errors: True
  register: stopped
  with_items: "{{ tomcats }}"

- name: Remove tomcats catalina.pid
  file: path={{ tomcat_base }}/{{ item.name }}/logs/catalina.pid state=absent
  with_items: "{{ tomcats }}"

- name: Start workers
  shell: "nohup {{ tomcat_base }}/{{ item.name }}/bin/startup.sh"
  args:
    creates: "{{ tomcat_base }}/{{ item.name }}/logs/catalina.pid"
  ignore_errors: True
  register: started
  with_items: "{{ tomcats }}"

- name: Wait for content/thredds initialization
  wait_for: path={{ tomcat_base }}/{{ item.name }}/content/thredds/catalog.xml delay=10
  when: started is changed
  with_items: "{{ tomcats }}"
