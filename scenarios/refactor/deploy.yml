- name: Deploy load balancers
  hosts: lbs
  roles:
    - role: yum
      dependencies: [httpd]
    - role: source
      dependencies: [mod_jk]
    - role: load-balancer
      lb_type: modjk

- name: Deploy workers
  hosts: workers
  roles:
    - role: yum
      dependencies: [jdk]
    - role: source
      dependencies: [tomcat]
    - role: worker
      load_balancer: lb
      catalogs: catalogs
      datasets: datasets
      worker_host: "{{ inventory_hostname }}"
  tasks:
    - name: Start workers
      shell: "nohup {{ tomcat_base }}/{{ item.name }}/bin/startup.sh"
      with_items: "{{ tomcats }}"
      ignore_errors: True

    - wait_for: port={{ item.port }} delay=10
      with_items: "{{ tomcats }}"
    - import_tasks: ../../utils/test-authentication.yml

    - name: Stop workers
      command: "{{ tomcat_base }}/{{ item.name }}/bin/shutdown.sh"
      with_items: "{{ tomcats }}"
      tags: [restart, stop]
      ignore_errors: True

    - wait_for: path={{ tomcat_base }}/{{ item.name }}/logs/catalina.pid state=absent
      with_items: "{{ tomcats }}"

    - name: Start workers
      shell: "nohup {{ tomcat_base }}/{{ item.name }}/bin/startup.sh"
      with_items: "{{ tomcats }}"
      tags: restart
      ignore_errors: True

- name: Restart load balancer
  hosts: lbs
  tasks:
    - name: Restart httpd
      service: name=httpd state=restarted
      tags: restart
