---
# Reread supervisord configuration and add httpd program to supervisord
- name: supervisor httpd
  supervisorctl:
    name: httpd
    state: present
    supervisorctl_path: "{{ venv_home }}/bin/supervisorctl"
    config: "{{ supervisord_etc }}/supervisord.conf"
    username: "{{ supervisord_user }}"
    password: "{{ supervisord_password }}"
    server_url: "http://localhost:{{ supervisord_port }}"

- name: start httpd
  supervisorctl:
    name: httpd
    state: started
    supervisorctl_path: "{{ venv_home }}/bin/supervisorctl"
    config: "{{ supervisord_etc }}/supervisord.conf"
    username: "{{ supervisord_user }}"
    password: "{{ supervisord_password }}"
    server_url: "http://localhost:{{ supervisord_port }}"

- name: stop httpd
  supervisorctl:
    name: httpd
    state: stopped
    supervisorctl_path: "{{ venv_home }}/bin/supervisorctl"
    config: "{{ supervisord_etc }}/supervisord.conf"
    username: "{{ supervisord_user }}"
    password: "{{ supervisord_password }}"
    server_url: "http://localhost:{{ supervisord_port }}"

- name: restart httpd
  supervisorctl:
    name: httpd
    state: restarted
    supervisorctl_path: "{{ venv_home }}/bin/supervisorctl"
    config: "{{ supervisord_etc }}/supervisord.conf"
    username: "{{ supervisord_user }}"
    password: "{{ supervisord_password }}"
    server_url: "http://localhost:{{ supervisord_port }}"

- name: start tomcat_instance
  supervisorctl:
    name: "{{ item.name }}"
    state: started
    supervisorctl_path: "{{ venv_home }}/bin/supervisorctl"
    config: "{{ supervisord_etc }}/supervisord.conf"
    username: "{{ supervisord_user }}"
    password: "{{ supervisord_password }}"
    server_url: "http://localhost:{{ supervisord_port }}"
  with_items:
    - "{{ tds_instances }}"
    - "{{ tap_instances }}"

- name: stop tomcat_instance
  supervisorctl:
    name: "{{ item.name }}"
    state: stopped
    supervisorctl_path: "{{ venv_home }}/bin/supervisorctl"
    config: "{{ supervisord_etc }}/supervisord.conf"
    username: "{{ supervisord_user }}"
    password: "{{ supervisord_password }}"
    server_url: "http://localhost:{{ supervisord_port }}"
  with_items:
    - "{{ tap_instances }}"
    - "{{ tds_instances }}"

- name: restart tomcat_instance
  supervisorctl:
    name: "{{ item.name }}"
    state: restarted
    supervisorctl_path: "{{ venv_home }}/bin/supervisorctl"
    config: "{{ supervisord_etc }}/supervisord.conf"
    username: "{{ supervisord_user }}"
    password: "{{ supervisord_password }}"
    server_url: "http://localhost:{{ supervisord_port }}"
  ignore_errors: True
  with_items:
    - "{{ tap_instances }}"
    - "{{ tds_instances }}"

- name: restart httpd
  supervisorctl:
    name: httpd
    state: restarted
    username: "{{ supervisord_user }}"
    password: "{{ supervisord_password }}"
#    server_url: "http://{{ hostvars[item].ansible_nodename }}:{{ supervisord_port }}"
    server_url: "http://localhost:{{ supervisord_port }}"
  run_once: True
  delegate_to: "{{ item }}"
  with_items: "{{ groups.proxies }}"
