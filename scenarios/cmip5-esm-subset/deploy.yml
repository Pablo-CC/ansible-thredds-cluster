- name: Deploy load balancers
  hosts: lbs
  vars:
    httpd_root: /etc/httpd
    httpd_conf_file: /etc/httpd/conf/esgf-httpd.conf
    httpd_version: 2.2.15
  roles:
    - role: load-balancer
      lb_type: modproxy
  pre_tasks:
    - name: Copy esgf-httpd.conf with /thredds disabled
      copy: src=esgf-httpd.conf dest=/etc/httpd/conf/esgf-httpd.conf

- name: Deploy workers
  hosts: workers
  vars:
    jdk_root: "{{ ansible_env.HOME }}/deployment/jdk"
    tomcat_home: "{{ ansible_env.HOME }}/deployment/tomcat"
    tds_root_catalog: /oceano/gmeteo/WORK/zequi/DATASETS/cmip5-esm-subset/catalogs/catalog.xml
  roles:
    - role: jdk-source
    - role: tomcat-source
    - role: worker
      load_balancer: spock
  tasks:
    - name: Link to cmip5-esm-subset catalogs
      file: state=link src=/oceano/gmeteo/WORK/zequi/DATASETS/cmip5-esm-subset/catalogs dest={{ tomcat_base }}/{{ item.name }}/content/thredds/cmip5-esm-subset
      with_items: "{{ tomcats }}"

    - import_tasks: ../../utils/restart.yml

- name: Restart load balancer
  hosts: lbs
  tasks:
    - name: Restart httpd
      service: name=httpd state=restarted
      tags: restart
