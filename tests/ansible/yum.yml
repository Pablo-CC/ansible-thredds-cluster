- hosts: gateways
  become: True
  vars:
    httpd_user: ansible
    httpd_group: ansible

    mod_proxy_status_user: proxy
    mod_proxy_status_passwd: proxy
  roles:
    - role: yum
      dependencies: [httpd]
    - role: httpd
    - role: gateway-proxy
  tasks:
    - name: Change httpd port to 8080
      become: True
      replace:
        path: "{{ httpd_conf_file }}"
        regexp: Listen 80$
        replace: Listen 8080

    - name: Enable httpd network connect in Selinux
      command: /usr/sbin/setsebool -P httpd_can_network_connect 1
        
    - name: restart httpd
      become: True
      command: httpd -k restart
      tags: [never, restart]

- hosts: tds
  become: True
  vars:
    ansible_become_pass: ansible
  roles:
    - role: yum
      dependencies: [jdk, tomcat, memcached]
    - role: tds
    - role: tds-collections
    - role: tds-modproxy
    - role: tomcat-memcached
      instances: "{{ tds }}"
  tasks:
    - include_tasks: ../../utils/test-authentication.yml
      vars:
        instances: "{{ tds }}"

    - name: Change group ownership of tds instances
      shell: chown -R :tomcat {{ tomcat_base }}/*

    - name: Add write permission to tomcat user in tds instances
      shell: chmod -R g+w {{ tomcat_base }}/*
      
    - name: start memcached
      command: memcached -d -u ansible

    - name: restart tds instances
      systemd:
        state: restarted
        name: "tomcat@{{ item.name }}.service"
      with_items: "{{ tds }}"
      tags: [never, restart]
