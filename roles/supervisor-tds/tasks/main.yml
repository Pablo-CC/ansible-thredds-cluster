- name: Create tomcat instances configuration file
  template:
    src: supervisor_wrapper.sh.j2
    dest: "{{ tomcat_base }}/{{ item.name }}/supervisor_wrapper.sh"
    mode: "u=rwx,g=rx,o=rx"
  with_items: "{{ tds }}"

- name: Create tomcat instances conf file into supervisord 
  template:
    src: tomcat.conf.j2
    dest: "{{ supervisor_programs }}/{{ item.name }}.conf"
  with_items: "{{ tds }}"
  register: tomcat_conf_supervisord

- name: Add tds_instance to supervisord
  supervisorctl:
    name: "{{ item.item.name }}"
    state: present
    supervisorctl_path: "{{ supervisor_bin }}/supervisorctl"
    config: "{{ supervisor_etc }}/supervisord.conf"
    username: "{{ supervisor_user | default(omit) }}"
    password: "{{ supervisor_password | default(omit) }}"
    server_url: "http://localhost:{{ supervisor_port }}"
  with_items: "{{ tomcat_conf_supervisord.results }}"
  when: item.changed
