---
# tasks file for nginx-tds

- name: Register at default upstream
  lineinfile:
    path: "{{ hostvars[item.1.proxy].nginx_conf_file_path }}"
    line: "\tserver {{ ansible_eth1.ipv4.address }}:{{ tds_port }};"
    insertafter: "upstream {{ hostvars[item.1.proxy].default_backend }} {\n"
  delegate_to: load-balancer
  with_subelements:
    - "{{ tds_instances }}"
    - replicas

- name: Register at specific upstream for my instance
  include_tasks: register_backend.yml
  with_subelements:
    - "{{ tds_instances }}"
    - replicas
  loop_control:
    loop_var: instance

- name: Copy tds static files
  include_tasks: tds-static-files.yml
  vars:
    ansible_become: "{{ hostvars[replica.1.proxy].ansible_become | default(False) }}"   #Depends on how NGINX was installed
  run_once: True
  loop_control:
    loop_var: replica
  with_subelements:
    - "{{ tds_instances }}"
    - replicas
