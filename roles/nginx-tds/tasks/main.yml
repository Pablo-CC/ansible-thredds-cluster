# We are going to write to the same file in a remote host, so we need to
# simulate serial, https://github.com/ansible/ansible/issues/12170#issuecomment-372263149
- name: Register at load balancer's upstream
  include_tasks: register_backend.yml
  with_items: "{{ ansible_play_batch }}"
  when: "hostvars[host_item].inventory_hostname == inventory_hostname"
  loop_control:
    loop_var: host_item

- name: Copy tds static files
  include_tasks: tds-static-files.yml
  vars:
    ansible_become: "{{ hostvars[replica.1.proxy].ansible_become | default(False) }}"   #Depends on how NGINX was installed
  run_once: True
  loop_control:
    loop_var: replica
  with_subelements:
    - "{{ tds_instances }}"
    - replicas
