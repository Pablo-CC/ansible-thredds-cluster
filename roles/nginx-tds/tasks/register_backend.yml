- name: Register at default upstream
  vars:
    ansible_become: "{{ hostvars[item.1.proxy].ansible_become | default(False) }}"
  lineinfile:
    path: "{{ hostvars[item.1.proxy].nginx_conf_file_path }}"
    line: "\tserver {{ ansible_eth1.ipv4.address }}:{{ tds_port }};"
    insertafter: "upstream {{ hostvars[item.1.proxy].default_backend }} {\n"
  delegate_to: "{{ item.1.proxy }}"
  with_subelements:
    - "{{ tds_instances }}"
    - replicas

- name: Register at specific upstream for my instance
  vars:
    ansible_become: "{{ hostvars[instance.1.proxy].ansible_become | default(False) }}"
  include_tasks: balance_servers.yml
  with_subelements:
    - "{{ tds_instances }}"
    - replicas
  loop_control:
    loop_var: instance

