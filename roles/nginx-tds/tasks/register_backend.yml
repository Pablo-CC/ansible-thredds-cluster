- name: Register at default upstream
  vars:
    ansible_become: "{{ hostvars[item.1.proxy].ansible_become | default(False) }}" #Depends on how NGINX was installed
  lineinfile:
    path: "{{ hostvars[item.1.proxy].nginx_conf_file_path }}"
    line: "\tserver {{ item.1.host }};"
    insertafter: "upstream {{ hostvars[item.1.proxy].default_upstream }} {\n"
  delegate_to: "{{ item.1.proxy }}"
  with_subelements:
    - "{{ tds_instances }}"
    - replicas

- name: Register at specific upstream for my instance
  vars:
    ansible_become: "{{ hostvars[instance.1.proxy].ansible_become | default(False) }}"
  include_tasks: balance_servers.yml
  with_subelements:
    - "{{ tds_instances }}"
    - replicas
  loop_control:
    loop_var: instance

