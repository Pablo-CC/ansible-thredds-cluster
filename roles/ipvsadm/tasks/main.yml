- name: Set new facts backend servers need
  set_fact:
    vip: "{{ bind_address }}"
    bind_port: "{{ bind_port }}"
    ipvs_rulefile_path: "{{ ipvs_rulefile_path }}"
    ansible_become: "{{ ansible_become | default(True) }}"

- name: Clear previous ipvsadm rules
  command: "ipvsadm -C"

- name: Add service on load balancer's interface
  command: "ipvsadm -A -t {{ bind_address }}:{{ bind_port }} -s rr"

- name: Make sure ipvsadm.rules exists
  file:
    path: "{{ ipvs_rulefile_path }}"
    state: touch

- name: Save rule
  command: "ipvsadm -S -n  > {{ ipvs_rulefile_path }}"
