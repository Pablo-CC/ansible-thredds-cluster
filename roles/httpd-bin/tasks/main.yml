- set_fact:
    ansible_become: "{{ ansible_become }}"

- name: Add epel-release repository
  become: True
  yum:
    name: epel-release

- name: Install required packages
  become: True
  yum:
    name: "{{ item }}"
    state: present
  with_items: "{{ httpd_dependencies }}" 

- name: Register httpd version
  command: bash -c "httpd -v | head -n1 | awk '{print substr($3,8,3)}'"
  register: httpd_version

- name: Print httpd version
  debug: var=httpd_version.stdout

- name: Copy httpd.conf
  template:
    src: httpd.conf.{{ httpd_version.stdout|replace(".","") }}.j2
    dest: /etc/httpd/conf/httpd.conf

- name: Delete existing files from conf.d
  file:
    state: absent
    path: /etc/httpd/conf.d/{{ item }}
  with_items: ["autoindex.conf", "userdir.conf", "welcome.conf"]

- name: Install python-passlib and httpd
  become: True
  yum:
    name: "{{ item }}"
    state: present
  with_items:
    - python-passlib
    - httpd
