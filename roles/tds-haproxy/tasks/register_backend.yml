- name: Register at load-balancer into default backend
  vars:
    ansible_become: "{{ hostvars[default_gateway].ansible_become | default(False)  }}" #Depends on how HAProxy was installed
  lineinfile:
    path: "{{ hostvars[default_gateway].haproxy_conf }}"
    line: "\tserver {{ ansible_hostname }} {{ default_host  }} cookie {{ ansible_hostname }}"
    state: present
    insertafter: "backend {{ hostvars[default_gateway].default_backend }}\n"
  delegate_to: "{{ default_gateway }}"

- name: Register at collections' specific backend 
  vars:
    ansible_become: "{{ hostvars[item.gateway].ansible_become | default(False)  }}" #Depends on how HAProxy was installed
  lineinfile:
    path: "{{ hostvars[item.gateway].haproxy_conf }}"
    line: "\t server {{ ansible_hostname }} {{ item.host }} cookie {{ ansible_hostname }}"
    insertafter: "backend {{ item.collection.path | replace('/', '-') }}"
  delegate_to: "{{ item.gateway }}"
  with_items: "{{ replicas }}"
