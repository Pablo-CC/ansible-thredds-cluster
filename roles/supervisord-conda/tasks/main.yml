- name: Create supervisor directories
  file:
    dest: "{{ item }}"
    state: directory
  with_items:
    - "{{ supervisord_etc }}"
    - "{{ supervisord_var }}"

- name: Create directory supervisord.d 
  file:
    dest: "{{ supervisord_programs }}"
    state: directory

- name: Create supervisord.conf
  template:
    src: supervisord.conf.j2
    dest: "{{ supervisord_etc }}/supervisord.conf"

- name: Check if supervisord is already running
  shell: netstat -tunlp | grep ":{{ supervisord_port }}"
  register: supervisor_sock
  failed_when: "'FAILED' in supervisor_sock.stderr"
  tags: boot

- name: Run supervisord if not already running
  shell: "{{ venv_home }}/bin/supervisord -c {{ supervisord_etc }}/supervisord.conf"
  tags: boot
  when: supervisor_sock.stdout == ""
