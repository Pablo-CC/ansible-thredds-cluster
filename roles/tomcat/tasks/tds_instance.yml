- name: Download tds
  run_once: True
  local_action: get_url
  args:
    url: "{{ tds_download_url }}"
    dest: "/tmp/{{ tds_filename }}"

- name: Create thredds directory in tomcat_catalina_home/webapps
  file:
    dest: "{{ tomcat_instances_path }}/{{ instance.name }}/webapps/thredds"
    state: directory

- name: Copy {{ tds_filename }} in webapps/thredds
  unarchive:
    src: "/tmp/{{ tds_filename }}"
    dest: "{{ tomcat_instances_path }}/{{ instance.name }}/webapps/thredds"
    
- name: Create content/thredds/ directories in tomcat_catalina_home
  file:
    dest: "{{ tomcat_catalina_home }}/content/thredds/{{ item }}"
    state: directory
    mode: "g+rwx"
  with_items:
    - gws
    - public    

- name: Create thredds log directory
  file:
    path: "{{ tomcat_instances_path }}/{{ instance.name }}/content/thredds/logs"
    state: directory

- name: Create soft link from instance content/thredds/public to tomcat
  file:
    dest: "{{ tomcat_instances_path }}/{{ instance.name }}/content/thredds/public"
    src: "{{ tomcat_catalina_home }}/content/thredds/public"
    force: yes
    state: link

- name: Create web.xml in WEB-INF
  copy:
    src: "{{ item }}"
    dest: "{{ tomcat_instances_path }}/{{ instance.name }}/webapps/thredds/WEB-INF/web.xml"
  with_first_found:
    - "{{ playbook_dir }}/{{ instance.files.web }}"
    - "{{ role_path }}/files/thredds_web.xml"
  notify: restart tomcat_instance

- copy:
    src: "{{ item }}"
    dest: "{{ tomcat_instances_path }}/{{ instance.name }}/content/thredds/threddsConfig.xml"
  with_first_found:
    - "{{ instance.files.threddsConfig }}"
    - "{{ role_path }}/files/threddsConfig.xml"

- name: Create directories for each GWS in tomcat instances
  file:
    dest: "{{ tomcat_instances_path }}/{{ instance.name }}/content/thredds/gws"
    state: directory
    mode: "g=rwx"

- name: Link GWS directory with each Tomcat instance
  file:
    src: "{{ tomcat_catalina_home }}/content/thredds/gws/{{ item.name }}"
    dest: "{{ tomcat_instances_path }}/{{ instance.name }}/content/thredds/gws/{{ item.name }}"
    state: link
  with_items: "{{ deployment.gws }}"

- name: Create a common catalog.xml in every instance
  copy:
    src: catalog.xml
    dest: "{{ tomcat_instances_path }}/{{ instance.name }}/content/thredds/catalog.xml"

- name: Link gws in the common catalog.xml
  blockinfile:
    dest: "{{ tomcat_instances_path }}/{{ instance.name }}/content/thredds/catalog.xml"
    marker: "<!-- {mark} {{ item.name }} -->"
    insertbefore: "</catalog>"
    block: |
      <catalogRef xlink:title="{{ item.name }}" xlink:href="gws/{{ item.name }}/catalog.xml" name=""/>
  with_items: "{{ deployment.gws }}"
  notify: start tomcat_instance
