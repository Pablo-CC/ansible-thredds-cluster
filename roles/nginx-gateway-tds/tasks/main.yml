---
# tasks file for nginx-gateway-tds
- name: Create upstreams for each collection
  blockinfile:
    path: "{{ nginx_conf_file }}"
    insertafter: "http {"
    block: |
      upstream {{ item.path | replace('/', '-') }} {
      }
    marker: "#{mark} {{ item.path | replace('/', '-') }} upstream block"
  with_items: "{{ collections }}"


- name: Create location blocks for collections
  blockinfile: 
    path: "{{ nginx_conf_file }}"
    insertafter: "listen {{bind_address}}:{{ bind_port }};"
    block: |4
          location ~ .*/{{ item.path | replace('/','-') }}.* {
            proxy_pass http://{{ item.path | replace('/', '-') }};
          }
    marker: "#{mark} {{ item.path | replace('/', '-') }} location block"
  with_items: "{{ collections }}"
