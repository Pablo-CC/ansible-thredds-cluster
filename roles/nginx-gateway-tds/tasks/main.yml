---
# tasks file for nginx-gateway-td
- name: Create default upstream
  blockinfile:
    path: "{{ nginx_conf_file }}"
    insertafter: "http {"
    block: |
      upstream {{ default_backend }} {
      }
    marker: "#{mark} {{ default_backend }} upstream block"
    

- name: Create upstreams for each collection
  blockinfile:
    path: "{{ nginx_conf_file }}"
    insertafter: "http {"
    block: |
      upstream {{ item.path | replace('/', '_') }} {
      }
    marker: "#{mark} {{ item.path | replace('/', '_') }} upstream block"
  with_items: "{{ collections }}"

- name: Create location block for default backend
  blockinfile:
    path: "{{ nginx_conf_file }}"
    insertafter: "listen {{ bind_port }};"
    block: |
      location / {
        proxy_pass http://{{ default_backend }};
      }
    marker: "#{mark} '/'(default) location block"

- name: Create location blocks for collections
  blockinfile: 
    path: "{{ nginx_conf_file }}"
    insertafter: "listen {{ bind_port }};"
    block: |
      location {{ item.1.base }} {
        proxy_pass http://{{ item.0.path | replace('/', '_') }};
      }
    marker: "#{mark} {{ item.1.base }}/{{ item.0.path | replace('/', '_') }} location block"
  with_subelements:
    - "{{ collections }}"
    - services
