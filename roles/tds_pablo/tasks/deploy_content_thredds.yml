- name: Set default content/thredds variable for instance
  set_fact:
    tds_instance_default_content_root: "{{ tomcat_base }}/{{ instance.name }}/content"
  tags: update_catalogs
    
- name: Create content/thredds/ directories in instances
  file:
    path: "{{ instance.tds_content_root | default(tds_instance_default_content_root) }}/thredds"
    state: directory

- name: Create soft link from instance content/thredds/public to tomcat
  file:
    dest: "{{ instance.tds_content_root | default(tds_instance_default_content_root) }}/thredds/public"
    src: "{{ tomcat_home }}/content/thredds/public"
    state: link

- name: Copy threddsConfig.xml
  copy:
    src: threddsConfig.xml
    dest: "{{ instance.tds_content_root | default(tds_instance_default_content_root) }}/thredds/threddsConfig.xml"

- name: Create a common catalog.xml in every instance
  copy:
    src: catalog.xml
    dest: "{{ instance.tds_content_root | default(tds_instance_default_content_root) }}/thredds/catalog.xml"

- name: Create directory {{ item.1.name }} in instance {{ instance.name }}
  file:
    dest: "{{ instance.tds_content_root | default(tds_instance_default_content_root) }}/thredds/{{ item.1.name }}"
    state: directory
  with_subelements:
    - "{{ instance.replicas }}"
    - collections
  when: item.1.server == ansible_hostname

- name: Link collection in the instance root catalog
  blockinfile:
    dest: "{{ instance.tds_content_root | default(tds_instance_default_content_root) }}/thredds/catalog.xml"
    marker: "<!-- {mark} {{ item.1.name }} -->"
    insertbefore: "</catalog>"
    block: |
      <catalogRef xlink:title="{{ item.1.name }}" xlink:href="{{ item.1.name }}/catalog.xml" name=""/>
  with_subelements: 
    - "{{ instance.replicas }}"
    - collections
