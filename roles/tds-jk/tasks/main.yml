- name: Add balance workers in proxy
  blockinfile:
    marker: "# {mark} worker_{{ ansible_hostname }}_{{ item.1.port }}"
    dest: "{{ hostvars[item.1.proxy].mod_jk_conf_path }}/mod_jk.workers"
    block: |
      worker.{{ worker_name }}.type=ajp13
      worker.{{ worker_name }}.host={{ ansible_host }}
      worker.{{ worker_name }}.port={{ item.1.port }}
  delegate_to: "{{ item.1.proxy }}"
  vars:
    ansible_become: "{{ hostvars[item.1.proxy].ansible_become | default(False) }}" # depends on how httpd was installed
    worker_name: "{{ tds_debug is not defined | ternary([ansible_hostname, item.1.port]|to_uuid, [ansible_hostname, item.1.port]|join('_')) }}"
  with_subelements:
    - "{{ tds_instances }}"
    - connectors
  when: item.1.type == "ajp"

- name: Register replicas in proxy
  include_tasks: jk_workers.yml
  with_subelements:
    - "{{ tds_instances }}"
    - replicas
  loop_control:
    loop_var: replica

- name: Set jvmRoute in tds instances
  replace:
    path: "{{ tomcat_base }}/{{ item.0.name }}/conf/server.xml"
    regexp: "<Engine(.*)>"
    replace: <Engine\1 jvmRoute="{{ worker_name }}">
  vars:
    worker_name: "{{ tds_debug is not defined | ternary([ansible_hostname, item.1.port]|to_uuid, [ansible_hostname, item.1.port]|join('_')) }}"
  with_subelements:
    - "{{ tds_instances }}"
    - connectors
  when:
    - item.1.type == "ajp"
