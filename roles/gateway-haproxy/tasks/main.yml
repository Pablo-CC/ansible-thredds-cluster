---
- name: Create ACL for each collection(1)
  lineinfile:
    path: "{{ haproxy_conf }}"
    line: "\tacl {{ item.path | replace('/', '-') }} path_beg /thredds/{{ item.path | replace('/', '-') }}"
    insertafter: "option forwardfor"
  with_items: "{{ collections }}"

- name: Create ACL for each collection(2)
  lineinfile:
    path: "{{ haproxy_conf }}"
    line: "\tacl {{ item.0.path | replace('/','-') }} path_beg {{ item.1 }}/{{ item.0.path }}"
    insertafter: "option forwardfor"
  with_subelements:
    - "{{ collections }}"
    - services

- name: Define ACL rule behaviour
  lineinfile: 
    path: "{{ haproxy_conf }}"
    line: "\tuse_backend {{ item.path | replace('/', '-') }} if {{ item.path | replace('/', '-') }}"
    insertbefore: "backend .*"
    firstmatch: True
  with_items: "{{ collections }}"

- name: Create backend block for each ACL rule
  lineinfile:
    path: "{{ haproxy_conf }}"
    line: "backend {{ item.path | replace('/', '-') }}"
  with_items: "{{ collections }}"


- name: Set cookie persistence for authentication in mapped backends
  lineinfile:
    path: "{{ haproxy_conf }}"
    line: "\tcookie JSESSIONID prefix nocache"
    insertafter: "backend {{ item.path | replace('/', '-') }}"
  with_items: "{{ collections }}"
