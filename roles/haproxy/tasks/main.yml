- name: Install dependencies
  become: True 
  yum: name={{ item }}
  with_items:
          - make
          - gcc
          - pcre-devel
          - openssl-devel
          - zlib-devel          
- name: Create directory for HAProxy
  become_user: vagrant
  file:
          path: "{{ haproxy_directory }}"
          state: directory

- name: Download HAProxy
  run_once: True
  local_action: get_url
  args:
          url: "{{ haproxy_url }}"
          dest: "/tmp/{{ haproxy_filename }}"
  vars:
          ansible_become: False
                          
- name: Unarchive HAProxy file
  unarchive:
          src: "/tmp/{{ haproxy_filename }}"
          dest: "{{ haproxy_directory }}"

- name: Insert destiny directory on Makefile
  lineinfile:
          path: "{{ haproxy_directory }}/{{ haproxy_version }}/Makefile"
          regexp: '^DESTDIR ='
          line: 'DESTDIR = {{ haproxy_directory }}/{{ haproxy_version }}'


- name: Compile source code
  make:
          chdir: "{{ haproxy_directory }}/{{ haproxy_version }}"
          params:
                  TARGET=linux2628
                  USE_PCRE=1
                  USE_ZLIB=1
                  USE_OPENSSL=1
                  DESTDIR={{ haproxy_directory }}
  creates: "{{ haproxy_directory }}/{{ haproxy_version }}/haproxy }}"

- name: Install HAProxy
  make:
          chdir: "{{ haproxy_directory }}/{{ haproxy_version }}"
          target: install

- name: Copy error files
  copy:
          src: errors
          dest: "{{ haproxy_directory }}/{{ haproxy_version }}"

- name: Add configuration file
  template:
          src: haproxy.cfg.j2
          dest: "{{ haproxy_directory }}/{{ haproxy_version }}/haproxy.cfg"

- name: Initiate HAProxy
  command: "./haproxy -f haproxy.cfg"
  args:
          chdir: "{{haproxy_directory }}/{{ haproxy_version }}"

