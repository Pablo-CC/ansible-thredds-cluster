- name: Create directory for THREDDS' static content
  file:
    path: "{{ hostvars[replica.gateway].nginx_static }}/thredds"
    state: directory
    mode: 0755
  delegate_to: "{{ replica.gateway }}"

- name: Create location block for static files
  blockinfile:
    path: "{{ hostvars[replica.gateway].nginx_conf }}"
    insertafter: "listen {{ hostvars[replica.gateway].bind_address }}:{{hostvars[replica.gateway].bind_port }};"
    block: |4
        location ~ .*(.png|.jpg|.gif|.css)$ {
          root static;
        }
    marker: "# {mark} static files block"
  delegate_to: "{{ replica.gateway }}"

- name: Create location block for static HTML files for TDS 
  blockinfile: 
    path: "{{ hostvars[replica.gateway].nginx_conf }}"
    insertafter: "listen {{ hostvars[replica.gateway].bind_address }}:{{hostvars[replica.gateway].bind_port }};"
    block: |4
        location ~ .*{{ item | basename }}$ {
          root static;
        }
    marker: "# {mark} {{ item | basename }} location block"
  delegate_to: "{{ replica.gateway }}"
  with_fileglob: "v{{ tds_version[:1]|string }}/*.html"

- name: Copy thredds static configuration files (images, css) for TDS 
  copy:
    src: "{{ item }}"
    dest: "{{ hostvars[replica.gateway].nginx_static }}/thredds/{{ item | basename }}"
    mode: 0644
  delegate_to: "{{ replica.gateway }}"
  with_fileglob: "v{{ tds_version[:1]|string }}/*"
