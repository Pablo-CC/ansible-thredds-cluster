- name: Register at main catalog's upstream
  vars:
    ansible_become: "{{ hostvars[item.gateway].ansible_become | default(False) }}" #Depends on how NGINX was installed
  blockinfile:
    path: "{{ hostvars[item.gateway].nginx_conf }}"
    insertafter: "upstream {{ hostvars[item.gateway].catalog_upstream }} {"
    block: "\tserver {{ item.host }}:{{ item.port }};"
    marker: "\t#{mark} {{ ansible_hostname }}'s register in {{ hostvars[item.gateway].catalog_upstream }} upstream"
  delegate_to: "{{ item.gateway }}"
  with_items: "{{ replicas }}"

- name: Register at restrictedAcces' upstream
  vars:
    ansible_become: "{{ hostvars[item.gateway].ansible_become | default(False) }}" #Depends on how NGINX was installed
  blockinfile:
    path: "{{ hostvars[item.gateway].nginx_conf }}"
    insertafter: "upstream {{ hostvars[item.gateway].restricted_upstream }} {"
    block: "\tserver {{ item.host }}:{{ item.port }};"
    marker: "\t#{mark} {{ ansible_hostname }}'s register in {{ hostvars[item.gateway].restricted_upstream }} upstream"
  delegate_to: "{{ item.gateway }}"
  with_items: "{{ replicas }}"

- name: Register at specific upstream for my instance
  vars:
    ansible_become: "{{ hostvars[item.gateway].ansible_become | default(False) }}"
  blockinfile:
    path: "{{ hostvars[item.gateway].nginx_conf }}"
    insertafter: "upstream {{ item.collection.path | replace('/', '-') }} {"
    block: "\t server {{ item.host }}:{{ item.port }};"
    marker: "\t#{mark} {{ ansible_hostname }}'s register in {{ item.collection.path | replace('/', '-') }} upstream"
  delegate_to: "{{ item.gateway }}"
  with_items: "{{ replicas }}"
