# Define which servers to include in the load balancing scheme. 
events {
  worker_connections 1024;
}

http {

  upstream backend {
   {% for server in groups['servers'] %}
   server {{ hostvars[server]['ansible_eth1']['ipv4']['address'] }}:{{ tds_port }};
   {% endfor %}
  }

  # This server accepts all traffic to port {{ bind_port }} and passes it to the upstream. 
  # Notice that the upstream name and the proxy_pass need to match.

  server {
    listen {{ bind_port }}; 
    location / {
    proxy_pass http://backend;
    }
  }
}
