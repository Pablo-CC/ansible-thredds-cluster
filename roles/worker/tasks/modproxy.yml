- name: Add workers to the modproxy lb worker
  lineinfile:
    dest: "{{ hostvars[load_balancer].modproxy_conf }}"
    insertafter: <Proxy \"balancer://{{ item.1 }}\">
    line: BalancerMember "ajp://{{ item.host | default(ansible_nodename) }}:{{ item.0.worker.port }}" loadfactor={{ item.0.worker.loadfactor | default(1) }} route={{ item.0.worker.route }}
  delegate_to: "{{ load_balancer }}"
  vars:
    ansible_become: "{{ hostvars[load_balancer].ansible_become | default(False) }}" # depends on how httpd was installed
  with_subelements:
    - "{{ tomcats }}"
    - worker.clusters

- name: Add java melody urimaps
  delegate_to: "{{ load_balancer }}"
  lineinfile:
    path: "{{ hostvars[load_balancer].modproxy_conf }}"
    line: ProxyPass "/monitoring/{{ item.worker.route }}" "http://{{ item.worker.host }}:{{ item.melody.port }}/{{ tds_context }}/monitoring"
  with_items: "{{ tomcats }}"
  when: tds_melody