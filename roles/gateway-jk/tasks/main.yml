- set_fact:
    ansible_become: "{{ ansible_become | default(False) }}"
    httpd_htdocs: "{{ httpd_htdocs }}" # tds-modjk needs to copy static web files
    mod_jk_conf: "{{ mod_jk_conf }}" # tds-modjk needs to register workers in mod_jk.workers file

- name: Create {{ mod_jk_conf }}
  file:
    state: directory
    path: "{{ mod_jk_conf }}"
    
- name: Reference mod_jk files from httpd.conf
  lineinfile:
    path: "{{ httpd_conf_file }}"
    line: Include {{ mod_jk_conf }}/*.conf
  
- name: Template mod_jk conf files
  template:
    src: "{{ item }}.j2"
    dest: "{{ mod_jk_conf }}/{{ item }}"
  with_items:
    - mod_jk.conf
    - mod_jk.workers
    - mod_jk.urimaps
  
- name: Create password for proxy status web pages
  htpasswd:
    path: "{{ mod_jk_status }}/.htpasswd"
    username: "{{ mod_jk_status_user }}"
    password: "{{ mod_jk_status_passwd }}"
  when:  mod_jk_status_user is defined and mod_jk_status_passwd is defined

# tds specific
- name: Create htdocs/thredds folder
  file:
    state: directory
    path: "{{ httpd_htdocs }}/thredds"

- name: Create configuration module for thredds
  template:
    src: thredds.conf.j2
    dest: "{{ mod_jk_conf }}/thredds.conf"

- name: Create thredds static configuration - serverInfo.html
  template:
    src: serverInfo.html.j2
    dest: "{{ httpd_htdocs }}/thredds/serverInfo.html"

- name: Add collections (jk lb workers)
  blockinfile:
    dest: "{{ mod_jk_conf }}/mod_jk.workers"
    marker: "# {mark} COLLECTION_{{ collection_name }}"
    block: |
      worker.list=COLLECTION_{{ collection_name }}
      worker.COLLECTION_{{ collection_name }}.type=lb
  vars:
    collection_name: "{{ item.path | replace('/', '-') }}"
  with_items: "{{ collections }}"

- name: Add collection urimaps
  blockinfile:
    path: "{{ mod_jk_conf }}/mod_jk.urimaps"
    marker: "# {mark} {{ item.1 }}/{{ item.0.path }}"
    block: |
      /thredds/{{ item.1 }}/{{ item.0.path }}=COLLECTION_{{ collection_name }}
      /thredds/{{ item.1 }}/{{ item.0.path }}/*=COLLECTION_{{ collection_name }}
  vars:
    collection_name: "{{ item.0.path | replace('/', '-') }}"
  with_subelements:
    - "{{ collections }}"
    - services

- name: Add restrictedAccess worker
  blockinfile:
    path: "{{ mod_jk_conf }}/mod_jk.workers"
    marker: "# {mark} restrictedAccess"
    block: |
      worker.list=restrictedAccess
      worker.restrictedAccess.type=lb
      worker.restrictedAccess.mount=/thredds/restrictedAccess/*
