---
# tasks file for nginx

- name: Export variables backend servers need
  set_fact:
    nginx_conf_file_path: "{{ nginx_conf_path }}/{{ nginx_conf_filename }}"
    ansible_become: "{{ ansible_become | default(False) }}"

- name: Download compressed file on local host
  local_action:
    module: get_url
    url: "{{ nginx_url_prefix }}/{{ nginx_filename }}"
    dest: "/tmp/{{ nginx_filename }}"

- name: Create directory for nginx
  file: 
    path: "{{ nginx_directory }}"
    state: directory

- name: Unarchive nginx file
  unarchive:
    src: "/tmp/{{ nginx_filename }}"
    dest: "{{ nginx_directory }}"

- name: Configure nginx installation
  command: "./configure --without-http_rewrite_module --without-http_gzip_module \
           --prefix={{ nginx_path_prefix }}"
  args:
    chdir: "{{ nginx_directory }}/{{ nginx_version }}"
    creates: "{{ nginx_directory }}/{{ nginx_version }}/Makefile"

- name: Install nginx
  make:
    chdir: "{{ nginx_directory }}/{{ nginx_version }}"
    target: install

- name: Create systemd unit file
  template:
    src: nginx.service.j2
    dest: /usr/lib/systemd/system/nginx.service
  vars:
    ansible_become: True

- name: Template configuration file for nginx
  template:
    src: nginx.conf.j2
    dest: "{{ nginx_conf_path }}/{{ nginx_conf_filename }}"
    mode: 0666
