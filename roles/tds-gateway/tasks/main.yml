# These facts are required by slaves to reference their proxies
- set_fact:
    mod_jk_hostname: "{{ ansible_nodename }}" # equals hostname
#    proxy_port: "{{ httpd_port }}"
    mod_jk_conf_path: "{{ mod_jk_conf_dir }}"
  tags: always

- include_tasks: "install_mod_jk.yml"

- name: Create mod_jk_conf_dir if not exists
  file: path={{ mod_jk_conf_dir }} state=directory

- name: Reference mod_jk files from httpd.conf
  lineinfile:
    path: "{{ httpd_conf }}"
    line: Include {{ mod_jk_conf_dir }}/*.conf
  
- name: Copy mod_jk.conf
  template:
    src: mod_jk.conf.j2
    dest: "{{ mod_jk_conf_dir }}/mod_jk.conf"

- name: Copy mod_jk.workers
  template:
    src: mod_jk.workers.j2
    dest: "{{ mod_jk_conf_dir }}/mod_jk.workers"

- name: Copy mod_jk.urimaps
  template:
    src: mod_jk.urimaps.j2
    dest: "{{ mod_jk_conf_dir }}/mod_jk.urimaps"

# Thredds's configuration
# For standalone tds-gateway role, httpd_document_root must be declared in playbook vars
# else it takes its value from role httpd, if not defined, following tasks are skiped
- name: Create configuration module for thredds
  template:
    src: thredds.conf.j2
    dest: "{{ mod_jk_conf_dir }}/thredds.conf"
  when: httpd_document_root is defined

- name: Create thredds directory in htdocs directory
  file:
    dest: "{{ httpd_document_root }}/thredds"
    state: directory
  when: httpd_document_root is defined

- name: Create thredds static configuration files (images, css)
  copy:
    src: "{{ item }}"
    dest: "{{ httpd_document_root }}/thredds/{{ item }}"
  when: httpd_document_root is defined
  with_items:
    - folder.gif
    - tdsCat.css
    - threddsIcon.gif
    - tds.css

- name: Create thredds static configuration - catalog.html
  template:
     src: catalog.html.j2
     dest: "{{ httpd_document_root }}/thredds/catalog.html"
  when: httpd_document_root is defined

- name: Create thredds static configuration - catalog.xml
  template:
    src: catalog.xml.j2
    dest: "{{ httpd_document_root }}/thredds/catalog.xml"
  when: httpd_document_root is defined

- name: Create thredds static configuration - serverInfo.html
  template:
    src: serverInfo.html.j2
    dest: "{{ httpd_document_root }}/thredds/serverInfo.html"
  when: httpd_document_root is defined
  
- name: Create password for proxy status web pages
  htpasswd:
    path: "{{ mod_jk_status_passwd }}/.htpasswd"
    username: "{{ applications.proxy.status.user }}"
    password: "{{ applications.proxy.status.password }}"
