- name: Register collection in tds gateway
  blockinfile:
    dest: "{{ hostvars[item.1.proxy].tdscc.mod_jk_conf_path }}/mod_jk.workers"
    marker: "# {mark} worker COLLECTION_{{ replica.1.name }}"
    block: |
      worker.list=COLLECTION_{{ replica.1.name | replace("/", "-") }}
      worker.COLLECTION_{{ replica.1.name | replace("/", "-") }}.type=lb
      worker.COLLECTION_{{ replica.1.name | replace("/", "-") }}.sticky_session=false
  delegate_to: "{{ item.1.proxy }}"
  when: item.1.proxy is defined
  with_subelements:
    - "{{ tds_instances }}"
    - connectors

- name: Add replicas to the collection
  lineinfile:
    dest: "{{ hostvars[item.1.proxy].tdscc.mod_jk_conf_path }}/mod_jk.workers"
    state: present
    line: 'worker.COLLECTION_{{ replica.1.name | replace("/", "-") }}.balance_workers={{ ansible_hostname }}_{{ item.1.port}}'
  delegate_to: "{{ item.1.proxy }}"
  with_subelements:
    - "{{ tds_instances }}"
    - connectors
  when: 
    - item.1.proxy is defined
    - item.1.type == "ajp"
    - replica.0.name == item.0.name

- name: Set the authenticator worker
  lineinfile:
    dest: "{{ hostvars[item.1.proxy].tdscc.mod_jk_conf_path }}/mod_jk.workers"
    state: present
    line: 'worker.authenticator.balance_workers={{ ansible_hostname }}_{{ item.1.port}}'
  delegate_to: "{{ item.1.proxy }}"
  with_subelements:
    - "{{ tds_instances }}"
    - connectors
  when: 
    - item.1.type == "ajp"
    - replica.0.name == item.0.name
