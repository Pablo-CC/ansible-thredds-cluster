# Create directories for each GWS in tds_instance_path/tds_instance/content/thredds/gws/
- name: Create directories for each GWS in {{ tds_instance_path }}
  file:
    dest: "{{ tds_instance_path }}/tds_{{ item.0.name }}/content/thredds/gws/{{ item.1 }}"
    state: directory
  with_subelements:
    - "{{ tds_instances }}"
    - catalog

# Create a generic catalog.xml for each TDS instance
- name: Create generic catalog.xml for each TDS instance
  copy:
    src: catalog.xml
    dest: "{{ tds_instance_path }}/tds_{{ item.name }}/content/thredds"
  with_items:
    - "{{ tds_instances }}"

# Create catalog.xml for each GWS
- name: Create catalog.xml in each GWS
  template: 
    src: catalog.xml.j2
    dest: "{{ tds_instance_path }}/tds_{{ item.0.name }}/content/thredds/gws/{{ item.1 }}/catalog.xml"
  with_subelements:
    - "{{ tds_instances }}"
    - catalog

- name: Link catalogs in the common catalog.xml
  blockinfile:
    dest: "{{ tds_instance_path }}/tds_{{ item.0.name }}/content/thredds/catalog.xml"
    marker: "# {mark} {{ item.1 }}"
    insertbefore: "</catalog>"
    block: |
      <catalogRef xlink:title="{{ item.1 }}" xlink:href="gws/{{ item.1 }}/catalog.xml" name=""/>
  with_subelements:
    - "{{ tds_instances }}"
    - catalog
  notify: restart tds_instance

# Add GWS load balancer configuration to mod_jk.workers file   
- name: Configure GWS in mod_jk.workers
  blockinfile:
    dest: "$HTTPD_HOME/conf.d/mod_jk.workers"
    marker: "# {mark} GWS_{{ item.name }}"
    block: |
      worker.list=GWS_{{ item.name }}
      worker.GWS_{{ item.name }}.type=lb
  with_items:
    - "{{ catalogs }}"
  delegate_to: hostC

# Add each instance configuration for GWS to mod_jk.workers file   
- name: Configure instances for GWS in mod_jk.workers
  blockinfile:
    dest: "$HTTPD_HOME/conf.d/mod_jk.workers"
    marker: "# {mark} GWS_{{ item.1 }}_{{ inventory_hostname }}_{{ item.0.base_port }}"
    block: |
      worker.GWS_{{ item.1 }}.balance_workers= {{ item.0.name }}

      worker.{{ item.0.name }}.type=ajp13
      worker.{{ item.0.name }}.host={{ item.0.ip_internal_address | default( item.0.ip_address ) }}
      worker.{{ item.0.name }}.port={{ item.0.ajp.port }}
  with_subelements:
    - "{{ tds_instances }}"
    - catalog
  delegate_to: hostC

# Add urimap for GWS in mod_jk.urimaps file   
- name: Configure urimap for GWS in mod_jk.urimaps
  blockinfile:
    dest: "$HTTPD_HOME/conf.d/mod_jk.urimaps"
    marker: "# {mark} GWS_{{ item.name }}"
    block: |
      /thredds/*/{{ item.name }}=GWS_{{ item.name }}
      /thredds/*/{{ item.name }}/*=GWS_{{ item.name }}
  with_items:
    - "{{ catalogs }}"
  delegate_to: hostC