# Create directories for each GWS in tds_instance_path/tds_instance/content/thredds/gws/
- name: Create directories for each GWS in {{ tds_instance_path }}
  file:
    dest: "{{ tds_instance_path }}/tds_{{ item.0.name }}/content/thredds/gws/{{ item.1.name }}"
    state: directory
  with_subelements:
    - "{{ tds_instances }}"
    - catalog

# Create a generic catalog.xml for each TDS instance
- name: Create generic catalog.xml for each TDS instance
  copy:
    src: catalog.xml
    dest: "{{ tds_instance_path }}/tds_{{ item.name }}/content/thredds"
  with_items:
    - "{{ tds_instances }}"

# Create catalog.xml for each GWS
- name: Create catalog.xml in each GWS
  template: 
    src: catalog.xml.j2
    dest: "{{ tds_instance_path }}/tds_{{ item.0.name }}/content/thredds/gws/{{ item.1.name }}/catalog.xml"
  with_subelements:
    - "{{ tds_instances }}"
    - catalog
  tags: test

- name: Link catalogs in the common catalog.xml
  blockinfile:
    dest: "{{ tds_instance_path }}/tds_{{ item.0.name }}/content/thredds/catalog.xml"
    marker: "# {mark} {{ item.1.name }}"
    insertbefore: "</catalog>"
    block: |
      <catalogRef xlink:title="{{ item.1.name }}" xlink:href="gws/{{ item.1.name }}/catalog.xml" name=""/>
  with_subelements:
    - "{{ tds_instances }}"
    - catalog
  notify: restart tds_instance