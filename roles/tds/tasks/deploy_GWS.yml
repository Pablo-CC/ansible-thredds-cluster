# Create directories for each GWS in tomcat_catalina_home/content/thredds/catalogs/
- name: Create directories for each GWS in {{ tomcat_catalina_home }}/content/thredds/catalogs/
  file:
    dest: "{{tomcat_catalina_home}}/content/thredds/catalogs/{{ item.name }}"
    state: directory
  with_items:
    - "{{ catalogs }}"

# Create catalog.xml for each GWS in tomcat_catalina_home/content/thredds/catalogs/
- name: Create catalog.xml in {{ tomcat_catalina_home }}/content/thredds/
  template: 
    src: catalog.xml.j2
    dest: "{{ tomcat_catalina_home }}/content/thredds/catalogs/{{ item.name }}/catalog.xml"
  with_items:
    - "{{ catalogs }}"
  register: create_catalogs

- name: Link catalogs in the common catalog.xml
  blockinfile:
    dest: "{{ tomcat_catalina_home }}/content/thredds/catalog.xml"
    marker: "# {mark} {{ item.0.name }}"
    insertbefore: "</catalog>"
    block: |
      <catalogRef xlink:title="{{ item.0.name }}" xlink:href="catalogs/{{ item.0.name }}/catalog.xml" name=""/>
  with_together:
    - "{{ catalogs }}"
    - "{{ create_catalogs.results }}"
  when:
    - item.1._ansible_item_result == true