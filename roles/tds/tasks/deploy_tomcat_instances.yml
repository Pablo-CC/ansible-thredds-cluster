# Create tomcat instances directory (tomcat_pool)
- name: Create tomcat_instances_path
  become: true
  file: 
    dest: "{{ tomcat_instances_path | default(tomcat_instances_path_default) }}"
    state: directory
    # mode: "u+rw,g+r,o-rwx"
    group: "{{ tomcat_default_user_group }}"

- name: Check if tomcat_instances_path directory exists
  find: 
    path: "{{ tomcat_instances_path | default(tomcat_instances_path_default) }}"
    patterns: "tomcat_{{ item.name }}"
    file_type: directory
  with_items:
    - "{{ tomcat_instances }}"
  register: tomcat_instances_directory

- name: Create directory for each tomcat instance
  become: true
  file:
    dest: "{{ tomcat_instances_path | default(tomcat_instances_path_default) }}/tomcat_{{ item.name }}"
    state: directory
    # mode: "u+rw,g+r,o-rwx"
    group: "{{ tomcat_default_user_group }}"
  with_items:
    - "{{ tomcat_instances }}"

- name: Copy directories from CATALINA_HOME to CATALINA_BASE
  become: true
  shell: cp -r {{ tomcat_catalina_home | default(tomcat_catalina_home_default) }}/{{ item.0 }}/ {{ tomcat_instances_path | default(tomcat_instances_path_default) }}/tomcat_{{ item.1.name }}/
  with_nested:
    - "{{ tomcat_instance_dirs }}"
    - "{{ tomcat_instances }}"
    - "{{ tomcat_instances_directory.results }}"
  when: (item.2.item.name == item.1.name) and (item.2.matched == 0 )

- name: Change group and mode for tomcat instace directories
  become: true
  shell: chown -R :{{ tomcat_default_user_group }} {{ tomcat_instances_path | default(tomcat_instances_path_default) }}/tomcat_{{ item.1.name }}/{{ item.0 }}
  with_nested:
    - "{{ tomcat_instance_dirs }}"
    - "{{ tomcat_instances }}"

- name: Change user for logs directory
  become: true
  shell: "chown -R {{ tomcat_default_user_name }}: {{ tomcat_instances_path | default(tomcat_instances_path_default) }}/tomcat_{{ item.name }}/logs"
  with_items:
    - "{{ tomcat_instances }}"

- name: Create logs directory in content/thredds for each tomcat instance
  become: true
  file:
    dest: "{{ tomcat_instances_path | default(tomcat_instances_path_default) }}/tomcat_{{ item.name }}/content/thredds/logs"
    state: directory
    # mode: "u+rw,g+r,o-rwx"
    owner: "{{ tomcat_default_user_name }}"
    group: "{{ tomcat_default_user_group }}"
  with_items:
    - "{{ tomcat_instances }}"

- name: Secure tomcat passwords
  become: true
  shell: "{{ tomcat_catalina_home | default(tomcat_catalina_home_default) }}/bin/digest.sh -a 'PBKDF2WithHmacSHA256' -i 100000 -s 16 -k 256 -h 'org.apache.catalina.realm.SecretKeyCredentialHandler' {{applications.tds[item.1.name].password}}"
  with_subelements:
    - "{{ tomcat_instances }}"
    - gws_instance
  register: "tomcat_passwords"

# Create server.xml in instances_path
- name: Create tomcat-users.xml file
  become: true
  template:
    src: tomcat-users.xml.j2
    dest: "{{ tomcat_instances_path | default(tomcat_instances_path_default) }}/tomcat_{{ item.name }}/conf/tomcat-users.xml"
    # mode: "u+rw,g+r,o-rwx"
    group: "{{ tomcat_default_user_group }}"
  with_items:
    - "{{ tomcat_instances }}"

# Create server.xml in instances_path
- name: Create server.xml file
  become: true
  template:
    src: server.xml.j2
    dest: "{{ tomcat_instances_path | default(tomcat_instances_path_default) }}/tomcat_{{ item.name }}/conf/server.xml"
    # mode: "u+rw,g+r,o-rwx"
    group: "{{ tomcat_default_user_group }}"
  with_items:
    - "{{ tomcat_instances }}"

# Create a web.xml in instances_path/webapps/thredds/WEB-INF
- name: Create web.xml in WEB-INF
  become: true
  copy:
    src: web.xml
    dest: "{{ tomcat_instances_path | default(tomcat_instances_path_default) }}/tomcat_{{ item.name }}/webapps/thredds/WEB-INF"
    # mode: "u+rw,g+r,o-rwx"
    group: "{{ tomcat_default_user_group }}"
  with_items:
    - "{{ tomcat_instances }}"

- name: Create Tomcat instances configuration in the system
  include: system_configuration.yml
  when: tomcat_system == true

- name: Create Tomcat instances configuration in the supervisord
  include: supervisord_configuration.yml
  when: tomcat_system == false