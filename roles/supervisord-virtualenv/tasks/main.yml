- name: Download virtualenv package
  local_action: get_url
  args:
    dest: "{{ tmp_dir }}"
    url: "{{ venv_file_url }}"
  run_once: True

- name: Create vitualenv directories
  file:
    dest: "{{ item }}"
    state: directory
  with_items:
    - "{{ venv_home }}"
    - "{{ venv_sw }}"
    
# Unarchive virtual enviroment package from local host to remote host
- name: Unarchive virtualenv
  unarchive: 
    src: "{{ tmp_dir }}/{{ venv_file_name }}"
    dest: "{{ venv_sw }}"

- name: Check if virtualenv is already created
  stat:
    path: "{{ venv_home }}/bin/activate"
  register: var_virtualenv_exists

# Create virtual enviroment in remote host only if it isn't created before
- name: Create virtualenv
  shell: "python virtualenv.py {{ venv_home }}"
  args:
    chdir: "{{ venv_sw }}/virtualenv-{{ venv_version }}"
  when: var_virtualenv_exists.stat.exists == false

#- name: Insert virtualenv in .bashrc file
#  lineinfile:
#    dest: "~/.bashrc"
#    line: "source {{ venv_home }}/bin/activate"

- name: Install supervisor
  pip:
    name: supervisor
    virtualenv: "{{ venv_home }}"
    virtualenv_site_packages: no
  register: supervisor_install

- name: Create supervisor directories
  file:
    dest: "{{ item }}"
    state: directory
  with_items:
    - "{{ supervisord_etc }}"
    - "{{ supervisord_var }}"

- name: Create directory supervisord.d 
  file:
    dest: "{{ supervisord_programs }}"
    state: directory

- name: Create supervisord.conf
  template:
    src: supervisord.conf.j2
    dest: "{{ supervisord_etc }}/supervisord.conf"

- name: Check if supervisord is activated
  stat:
    path: "{{ supervisord_var }}/supervisor.sock"
  tags: start

- name: Check if supervisord is already running
  shell: netstat -tunlp | grep ":{{ supervisord_port }}"
  register: supervisor_sock
  failed_when: "'FAILED' in supervisor_sock.stderr"

# LISTENER???
# Activate virtual enviroment for running supervisord process only when supervisord package is installed 
- name: Run supervisord
  shell: "{{ venv_home }}/bin/supervisord -c {{ supervisord_etc }}/supervisord.conf"
  tags: start
  when: supervisor_sock.stdout == ""

