- name: Register at load-balancer into default backend
  vars:
    ansible_become: "{{ hostvars[item.1.proxy].ansible_become | default(False)  }}" #Depends on how HAProxy was installed
  lineinfile:
    path: "{{ hostvars[item.1.proxy].haproxy_conf_file }}"
    line: "\tserver {{ ansible_hostname }} {{ item.1.host  }} cookie {{ ansible_hostname }}"
    state: present
    insertafter: "backend {{ hostvars[item.1.proxy].default_backend }}\n"
  delegate_to: "{{ item.1.proxy }}"
  with_subelements:
    - "{{ tds_instances }}"
    - replicas

- name: Register at collections' specific backend 
  include_tasks: balance_servers.yml
  vars:
    ansible_become: "{{ hostvars[instance.1.proxy].ansible_become | default(False)  }}" #Depends on how HAProxy was installed
  with_subelements:
    - "{{ tds_instances }}"
    - replicas
  loop_control:
    loop_var: instance
