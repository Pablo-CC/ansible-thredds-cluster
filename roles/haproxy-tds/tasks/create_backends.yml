#- name: Check if backend exists
# vars:
#   ansible_become: "{{ hostvars[item.1.proxy].ansible_become }}"
# command: "grep {{ hostvars[item.1.proxy].haproxy_conf_file }} -e 'backend {{ collection.backend }}'"
# ignore_errors: True #When Grep doesn't find anything return code = 1 (Alternative: https://stackoverflow.com/a/41011953)
# with_subelements:
#   - "{{ tds_instances }}"
#   - replicas
# delegate_to: "{{ item.1.proxy }}"
# register: grep_test

- name: Create backend for collection
  vars:
    ansible_become: "{{ hostvars[item.1.proxy].ansible_become }}"
  lineinfile:
    path: "{{ hostvars[item.1.proxy].haproxy_conf_file }}"
    line: "backend {{ collection.backend }}"
  with_subelements:
    - "{{ tds_instances }}"
    - replicas
  delegate_to: "{{ item.1.proxy }}"
