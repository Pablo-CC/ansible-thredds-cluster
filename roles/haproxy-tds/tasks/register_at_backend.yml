- name: Make sure {{ item.backend }} backend exists
  lineinfile:
    path: "{{ hostvars[instance.1.proxy].haproxy_conf_file }}"
    line: "backend {{ item.backend }}\n"
  with_items: "{{ collections }}"
  #when: item.server == ansible_hostname
  delegate_to: "{{ instance.1.proxy }}"

- name: Register at load-balancer into {{ item.backend }} backend
  lineinfile:
    path: "{{ hostvars[instance.1.proxy].haproxy_conf_file }}"
    line: "\tserver {{ ansible_hostname }} {{ ansible_eth1.ipv4.address}}:{{ tds_port }}"
    insertafter: "backend {{ item.backend }}\n"
  with_items: "{{ collections }}"
  #  when: item.server == ansible_hostname
  delegate_to: "{{ instance.1.proxy }}"

