- name: Register at load-balancer into {{ item.backend }} backend
  vars:
    ansible_become: "{{ hostvars[item.1.proxy].ansible_become }}"
  lineinfile:
    path: "{{ hostvars[item.1.proxy].haproxy_conf_file }}"
    line: "\tserver {{ ansible_hostname }} {{ ansible_eth1.ipv4.address}}:{{ tds_port }}"
    insertafter: "backend {{ collection.backend }}\n"
  with_subelements:
    - "{{ tds_instances }}"
    - replicas
  when: collection.server == ansible_hostname
  delegate_to: "{{ item.1.proxy }}"

