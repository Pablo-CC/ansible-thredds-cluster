- name: Register as backend server in load-balancer
  vars:
    ansible_become: "{{ hostvars[item.1.proxy].ansible_become | default(False) }}"
  command: "ipvsadm -a -t {{ hostvars[item.1.proxy].vip }}:{{ hostvars[item.1.proxy].bind_port  }} -r {{ ansible_eth1.ipv4.address }}:{{ hostvars[item.1.proxy].bind_port  }} -g"
  delegate_to: "{{ item.1.proxy }}"
  with_subelements:
    - "{{ tds_instances }}"
    - replicas

- name: Save rule
  become: True
  command: "echo -a -t {{ hostvars[item.1.proxy].vip }}:{{ hostvars[item.1.proxy].bind_port  }} \
            -r {{ ansible_eth1.ipv4.address }}:{{ hostvars[item.1.proxy].bind_port  }} \
            >> {{ hostvars[item.1.proxy].ipvs_rulefile_path }} -g"
  delegate_to: "{{ item.1.proxy }}"
  with_subelements:
    - "{{ tds_instances }}"
    - replicas
