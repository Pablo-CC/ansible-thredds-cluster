- name: Register as backend server in load-balancer
  vars:
    ansible_become: "{{ hostvars[item.1.proxy].ansible_become | default(False) }}"
  command: "ipvsadm -a -t {{ hostvars[item.1.proxy].vip }}:{{ hostvars[item.1.proxy].bind_port  }} -r {{ item.1.host }} -g"
  delegate_to: "{{ item.1.proxy }}"
  with_subelements:
    - "{{ tds_instances }}"
    - replicas

- name: Save rules
  vars:
    ansible_become: "{{ hostvars[item.1.proxy].ansible_become | default(False) }}"
  command: "ipvsadm-save > {{ hostvars[item.1.proxy].ipvs_rulefile_path }}"
  delegate_to: "{{ item.1.proxy }}"
  with_subelements:
    - "{{ tds_instances }}"
    - replicas
