- name: Add <Cluster> to tds_instances
  lineinfile:
    path: "{{ tomcat_base }}/{{ item.name }}/conf/server.xml"
    insertbefore: </Host>
    line: <Cluster className="org.apache.catalina.ha.tcp.SimpleTcpCluster"/>
  with_items: "{{ tds_instances }}"
  
- name: Copy TdsClusterAuthorizer in every instance
  copy:
    src: TdsClusterAuthorizer{{ tds_major_version }}.class
    dest: "{{ tomcat_base }}/{{ item.name }}/webapps/thredds/WEB-INF/classes/thredds/servlet/restrict/TdsClusterAuthorizer{{ tds_major_version }}.class"
  with_items: "{{ tds_instances }}"

- name: Substitute TomcatAuthorizer by TdsClusterAuthorizer in applicationContext.xml (for TDS 5)
  replace:
    regexp: '<bean id="restrictedDatasetAuthorizer" class="thredds.servlet.restrict.TomcatAuthorizer">'
    replace: '<bean id="restrictedDatasetAuthorizer" class="thredds.servlet.restrict.TdsClusterAuthorizer{{ tds_major_version }}">'
    path: "{{ tomcat_base }}/{{ item.name }}/webapps/thredds/WEB-INF/applicationContext.xml"
  with_items: "{{ tds_instances }}"
  when: tds_major_version == 5|string

- name: Substitute TomcatAuthorizer by TdsClusterAuthorizer in web.xml (for TDS 4)
  replace:
    regexp: TomcatAuthorizer
    replace: TdsClusterAuthorizer{{ tds_major_version }}
    path: "{{ tomcat_base }}/{{ item.name }}/webapps/thredds/WEB-INF/web.xml"
  with_items: "{{ tds_instances }}"
  when: tds_major_version == 4|string

