- name: Create htdocs/thredds folder
  file:
    state: directory
    path: "{{ httpd_htdocs }}/thredds"

- name: Create configuration module for thredds
  template:
    src: thredds.conf.j2
    dest: "{{ mod_jk_conf }}/thredds.conf"

- name: Create thredds static configuration - serverInfo.html
  template:
    src: serverInfo.html.j2
    dest: "{{ httpd_htdocs }}/thredds/serverInfo.html"

- name: Add collections (jk lb workers)
  blockinfile:
    dest: "{{ mod_jk_conf }}/mod_jk.workers"
    marker: "# {mark} COLLECTION_{{ collection_name }}"
    block: |
      worker.list=COLLECTION_{{ collection_name }}
      worker.COLLECTION_{{ collection_name }}.type=lb
  vars:
    collection_name: "{{ item.path | replace('/', '-') }}"
  with_items: "{{ collections }}"

- name: Add collection urimaps
  blockinfile:
    path: "{{ mod_jk_conf }}/mod_jk.urimaps"
    marker: "# {mark} {{ item.1 }}/{{ item.0.path }}"
    block: |
      /thredds/{{ item.1 }}/{{ item.0.path }}=COLLECTION_{{ collection_name }}
      /thredds/{{ item.1 }}/{{ item.0.path }}/*=COLLECTION_{{ collection_name }}
  vars:
    collection_name: "{{ item.0.path | replace('/', '-') }}"
  with_subelements:
    - "{{ collections }}"
    - services

- name: Add restrictedAccess worker
  blockinfile:
    path: "{{ mod_jk_conf }}/mod_jk.workers"
    marker: "# {mark} restrictedAccess"
    block: |
      worker.list=restrictedAccess
      worker.restrictedAccess.type=lb
      worker.restrictedAccess.mount=/thredds/restrictedAccess/*
