#Check if the service is installed in remote host
- name: Check if the service is installed
  include: "{{ httpd_path_to_lib_role }}/lib/tasks/check_service_install.yml"
  vars:
    service_home: "{{ httpd_install_base }}"

- name: Start installation if httpd is not installed
  include: install_httpd.yml
  when: service_name not in service_installed.stdout

- name: Insert HTTPD_HOME in .bashrc file
  lineinfile:
    dest: "~/.bashrc"
    line: "export HTTPD_HOME={{ httpd_opt }}"

# Create conf.d directory in httpd_home
- name: Create modules directories
  file:
    dest: "{{ httpd_opt }}/{{ conf_modules }}"
    state: directory

# Create jk configuration file in http configuration
- name: Configure jk module
  template:
    src: mod_jk.conf.j2
    dest: "{{ httpd_opt }}/conf.d/mod_jk.conf"

# Create general worker.properties configuration file for mod_jk in httpd configuration
- name: Configure general worker properties
  template:
    src: mod_jk.workers.j2
    dest: "{{ httpd_opt }}/conf.d/mod_jk.workers"

# Create general worker.properties configuration file for mod_jk in httpd configuration
- name: Configure mod_jk urimaps
  template:
    src: mod_jk.urimaps.j2
    dest: "{{ httpd_opt }}/conf.d/mod_jk.urimaps"

# Create httpd configuration
- name: Copy httpd.conf in host
  template: 
    src: httpd.conf.j2
    dest: "{{ httpd_opt }}/conf/httpd.conf"

# Create index.html page
- name: Create index page
  template:
    src: "{{ httpd_default_index_html_template }}"
    dest: "{{ httpd_opt }}/htdocs/index.html"

## Control httpd with supervisord
# Create httpd configuration file in supervisord
- name: Create httpd supervisord configuration
  template:
    src: httpd_supervisord.conf.j2
    dest: "{{ supervisor_programs }}/httpd.conf"
  register: httpd_conf_supervisord

# Reread supervisord configuration and add httpd program to supervisord
- name: Add httpd program to supervisord
  supervisorctl:
    name: httpd
    state: present
    supervisorctl_path: "{{ virtualenv_home }}/bin/supervisorctl"
    config: "{{ supervisor_etc }}/supervisord.conf"
  when: httpd_conf_supervisord.changed
