- set_fact:
    httpd_conf_path: "{{ httpd_conf_path }}"
    httpd_document_root: "{{ httpd_document_root }}"

- include_tasks: install_from_source.yml
  when: httpd_source
  tags: install

- include_tasks: install_from_binary.yml
  when: not httpd_source
  tags: install

- name: Copy httpd.conf
  template: 
    src: httpd.conf.j2
    dest: "{{ httpd_conf_path }}/httpd.conf"

- name: Create httpd supervisord configuration
  template:
    src: httpd_supervisord.conf.j2
    dest: "{{ supervisord_programs }}/httpd.conf"
  when: httpd_source

- name: Create password for proxy status web pages
  htpasswd:
    path: "{{ httpd_document_root }}/.htpasswd"
    username: "{{ applications.proxy.status.user }}"
    password: "{{ applications.proxy.status.password }}"

# Reread supervisord configuration and add httpd program to supervisord
- name: supervisor httpd
  supervisorctl:
    name: httpd
    state: present
    supervisorctl_path: "{{ venv_home }}/bin/supervisorctl"
    config: "{{ supervisord_etc }}/supervisord.conf"
    username: "{{ applications.supervisord.user }}"
    password: "{{ applications.supervisord.password }}"
    server_url: "http://localhost:{{ supervisord_port }}"
  when: httpd_source
