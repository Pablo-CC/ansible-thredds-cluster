- set_fact:
    ansible_become: "{{ ansible_become | default(False) }}"
    venv_home: "{{ venv_home }}"
    httpd_conf_path: "{{ httpd_conf_path }}"
    httpd_document_root: "{{ httpd_document_root }}"
  tags: always

- include_tasks: install_from_source.yml
  tags: install,httpd

- name: Copy httpd.conf
  template: 
    src: httpd.conf.2{{ httpd_version_major|last }}.j2
    dest: "{{ httpd_conf_path }}/httpd.conf"

- name: Create httpd supervisord configuration
  template:
    src: httpd_supervisord.conf.j2
    dest: "{{ supervisord_programs }}/httpd.conf"

- name: Create password for proxy status web pages
  htpasswd:
    path: "{{ httpd_document_root }}/.htpasswd"
    username: "{{ applications.proxy.status.user }}"
    password: "{{ applications.proxy.status.password }}"

# Reread supervisord configuration and add httpd program to supervisord
- name: supervisor httpd
  supervisorctl:
    name: httpd
    state: present
    supervisorctl_path: "{{ venv_home }}/bin/supervisorctl"
    config: "{{ supervisord_etc }}/supervisord.conf"
    username: "{{ applications.supervisord.user }}"
    password: "{{ applications.supervisord.password }}"
    server_url: "http://localhost:{{ supervisord_port }}"
