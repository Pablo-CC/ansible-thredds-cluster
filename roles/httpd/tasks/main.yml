# This fact is required by slaves to update proxy's workers
- set_fact:
    httpd_confd: "{{ httpd_confd_dir }}"
  tags: always

- include_tasks: install_from_source.yml
  when: httpd_source

- include_tasks: install_from_binary.yml
  when: not httpd_source

# Create httpd configuration
- name: Copy httpd.conf in host
  become: "{{ httpd_become_enabled }}"
  template: 
    src: httpd.conf.j2
    dest: "{{ httpd_conf_dir }}/httpd.conf"

# Create index.html page
- name: Create index page
  become: "{{ httpd_become_enabled }}"
  template:
    src: index.html.j2
    dest: "{{ httpd_document_root }}/index.html"

# Create httpd configuration file in supervisord
- name: Create httpd supervisord configuration
  become: "{{ httpd_become_enabled }}"
  template:
    src: httpd_supervisord.conf.j2
    dest: "{{ supervisord_programs }}/httpd.conf"
  when: httpd_source
  notify: 
    - start httpd

# Reread supervisord configuration and add httpd program to supervisord
- name: supervisor httpd
  supervisorctl:
    name: httpd
    state: present
    supervisorctl_path: "{{ venv_home }}/bin/supervisorctl"
    config: "{{ supervisord_etc }}/supervisord.conf"
    username: "{{ applications.supervisord.user }}"
    password: "{{ applications.supervisord.password }}"
    server_url: "http://localhost:{{ supervisord_port }}"
  when: httpd_source
